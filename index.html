<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="fullscreen=(self)">
    <title>ConeWorks</title>
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: visible !important;
        }
        h1 {
            font-size: 3.5em;
            text-shadow: 0 0 10px #00ffcc;
            margin-bottom: 10px;
        }
        p {
            font-size: 1.2em;
            max-width: 600px;
            text-align: center;
            margin-bottom: 20px;
        }
        #versionDisplay {
            font-size: 1em;
            color: #00ffcc;
            margin-bottom: 20px;
        }
        .login-container, .game-buttons, .settings-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        .game-buttons { flex-direction: row; flex-wrap: wrap; }
        input, button, select {
            padding: 10px;
            font-size: 1.1em;
            border: none;
            border-radius: 5px;
        }
        input, select {
            width: 200px;
            background: #fff;
            color: #333;
        }
        button {
            background: linear-gradient(to right, #ff6b6b, #ff8e53);
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 5000 !important;
        }
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        button#resetDataBtn {
            background: #f44336;
        }
        canvas {
            display: none;
            border: 3px solid #00ffcc;
            border-radius: 10px;
            background: #000;
        }
        #ui {
            position: fixed !important;
            top: 10px !important;
            left: 10px !important;
            z-index: 5000 !important;
            font-size: 24px !important;
            background: rgba(0, 0, 0, 0.9) !important;
            padding: 20px !important;
            border-radius: 5px !important;
            border: 2px solid #00ffcc !important;
            display: none !important;
            visibility: visible !important;
            opacity: 1 !important;
            overflow: visible !important;
            touch-action: auto !important;
            min-width: 200px !important;
        }
        #ui button {
            margin: 10px !important;
            padding: 20px !important;
            font-size: 24px !important;
            width: 180px !important;
            text-align: center !important;
            border-radius: 5px !important;
            border: 2px solid white !important;
            opacity: 1 !important;
            z-index: 5000 !important;
        }
        #testButton, #testButton2 {
            background: #ff0000 !important;
            color: white !important;
            border: 2px solid white !important;
            z-index: 5000 !important;
        }
        #publicChat {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 300px;
            height: 150px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            font-size: 14px;
            overflow-y: auto;
            display: none;
        }
        #publicChatInput {
            width: 280px;
            margin-top: 5px;
        }
        #chatBox {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            display: none;
            font-size: 14px;
            overflow-y: auto;
        }
        #chatInput {
            width: 380px;
            margin-top: 5px;
        }
        #friendBox {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 250px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            display: none;
            font-size: 14px;
        }
        #playerListBox {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            display: none;
            font-size: 14px;
            overflow-y: auto;
            max-height: 400px;
        }
        #friendSearch, #serverSearch, #newServerName, #deleteUsername, #deletePassword {
            width: 220px;
            margin-bottom: 5px;
        }
        #friendSuggestions, #serverSuggestions {
            max-height: 100px;
            overflow-y: auto;
            background: #333;
            border-radius: 5px;
        }
        .suggestion {
            padding: 5px;
            cursor: pointer;
        }
        .suggestion:hover {
            background: #555;
        }
        #notification {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: #00ffcc;
            color: #000;
            padding: 10px;
            border-radius: 5px;
            display: none;
            max-width: 300px;
        }
        #voteBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        #reportBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        #reviewReportsBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
            max-height: 500px;
            overflow-y: auto;
            width: 400px;
        }
        #shopBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        #skinBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        #deleteAccountBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        .back-btn {
            position: absolute;
            top: 50px;
            right: 10px;
            padding: 10px 20px;
            background: #f44336;
            color: white;
        }
        .back-btn:hover {
            background: #da190b;
        }
        #fullscreenBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 5000;
        }
        #coneconDisplay {
            position: absolute;
            top: 10px;
            font-size: 20px;
            color: yellow;
            z-index: 5000;
        }
        #controlsBox {
            display: none;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            text-align: left;
            max-width: 300px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 5px;
            text-align: left;
            border-bottom: 1px solid #555;
        }
    </style>
</head>
<body>
    <button id="fullscreenBtn" onclick="toggleFullscreen()">Fullscreen</button>
    <div id="loginPage">
        <h1>ConeWorks</h1>
        <div id="versionDisplay">Version 3.4</div>
        <p>Sign in or create an account to brawl and chill!</p>
        <div class="login-container">
            <input id="username" type="text" placeholder="Username">
            <input id="password" type="password" placeholder="Password">
            <button onclick="login()">Login</button>
            <button onclick="signup()">Sign Up</button>
            <button onclick="toggleControls()">Show Controls</button>
            <button id="resetDataBtn" onclick="resetData()">Reset Data</button>
            <div id="controlsBox">
                <h3>Controls</h3>
                <ul>
                    <li><b>WASD/Arrow Keys</b>: Move (camera-relative)</li>
                    <li><b>Space</b>: Jump</li>
                    <li><b>E</b>: Attack (Fight mode)</li>
                    <li><b>C</b>: Toggle server chat</li>
                    <li><b>UI Buttons</b>: Open Skin Shop, Weapon Shop, Player List, Toggle POV, Report Player</li>
                </ul>
            </div>
        </div>
    </div>
    <div id="homePage" style="display: none;">
        <div id="coneconDisplay">Conecons: 0</div>
        <h1>ConeWorks</h1>
        <div id="versionDisplay">Version 3.4</div>
        <p>Create or join epic servers to brawl or chill.</p>
        <div class="game-buttons">
            <button onclick="loadServerPage()">Join Server</button>
            <button onclick="loadCreateServerPage()">Create Server</button>
            <button onclick="toggleChatBox()">Chat & Friends</button>
            <button onclick="toggleFriendBox()">Search Players</button>
            <button onclick="togglePlayerList()">Player List</button>
            <button onclick="testMultiplayer()">Test Multiplayer</button>
            <button onclick="loadSettingsPage()">Settings</button>
            <button onclick="testUI()">Test UI</button>
            <button onclick="testUI2()">Test UI 2</button>
            <button id="reviewReportsBtn" style="display: none;" onclick="reviewReports()">Review Reports</button>
        </div>
        <p>Earn 1 Conecon per minute in-game to buy skins and weapons!</p>
    </div>
    <div id="serverPage" style="display: none;">
        <h1>Join a Server</h1>
        <p>Search for a server or join a random one!</p>
        <input id="serverSearch" type="text" placeholder="Search servers..." oninput="updateServerSuggestions(); updateServerList()">
        <label for="modeFilter">Filter Mode:</label>
        <select id="modeFilter" aria-label="Filter servers by game mode" onchange="updateServerSuggestions(); updateServerList()">
            <option value="all">All Modes</option>
            <option value="fight">Fight</option>
            <option value="chill">Chill</option>
        </select>
        <div id="serverSuggestions"></div>
        <div id="serverList">
            <table>
                <thead>
                    <tr><th>Name</th><th>Mode</th><th>Players</th><th>Action</th></tr>
                </thead>
                <tbody id="serverTableBody"></tbody>
            </table>
        </div>
        <div class="game-buttons">
            <button onclick="joinServer('random')">Join Random</button>
            <button onclick="joinServer(document.getElementById('serverSearch').value)">Join Server</button>
            <button onclick="showHome()">Back</button>
        </div>
    </div>
    <div id="createServerPage" style="display: none;">
        <h1>Create a Server</h1>
        <p>Choose a name and mode for your server!</p>
        <input id="newServerName" type="text" placeholder="Server Name">
        <label for="newServerMode">Server Mode:</label>
        <select id="newServerMode" aria-label="Select server game mode">
            <option value="fight">Fight</option>
            <option value="chill">Chill</option>
        </select>
        <div class="game-buttons">
            <button onclick="createServer()">Create</button>
            <button onclick="showHome()">Back</button>
        </div>
    </div>
    <div id="settingsPage" style="display: none;">
        <h1>Settings</h1>
        <p>Customize your ConeWorks experience.</p>
        <div class="settings-container">
            <label for="defaultPOV">Default POV on Join:</label>
            <select id="defaultPOV" aria-label="Select default camera perspective">
                <option value="third">Third-Person</option>
                <option value="first">First-Person</option>
            </select>
            <label for="mouseSensitivity">Mouse Sensitivity:</label>
            <input type="range" id="mouseSensitivity" min="0.001" max="0.01" step="0.001" value="0.002">
            <label for="currencyDisplay">Currency Display:</label>
            <select id="currencyDisplay" aria-label="Select currency display position">
                <option value="top-left">Top-Left</option>
                <option value="top-right">Top-Right</option>
            </select>
            <button onclick="saveSettings()">Save</button>
            <button onclick="backupData()">Backup Data</button>
            <button onclick="restoreData()">Restore Data</button>
            <button onclick="showDeleteAccount()">Delete Account</button>
            <button onclick="showHome()">Back</button>
        </div>
    </div>
    <div id="deleteAccountBox" style="display: none;">
        <h2>Delete Account</h2>
        <p>Enter your username and password to confirm deletion.</p>
        <input id="deleteUsername" type="text" placeholder="Username">
        <input id="deletePassword" type="password" placeholder="Password">
        <div class="game-buttons">
            <button onclick="deleteAccount()">Confirm Delete</button>
            <button onclick="document.getElementById('deleteAccountBox').style.display='none'">Cancel</button>
        </div>
    </div>
    <div id="playerListBox" style="display: none;">
        <h2>Player Leaderboard</h2>
        <table>
            <thead>
                <tr><th>Username</th><th>Wins</th><th>Conecons</th><th>Action</th></tr>
            </thead>
            <tbody id="playerList"></tbody>
        </table>
        <button onclick="togglePlayerList()">Close</button>
    </div>
    <canvas id="canvas" width="800" height="600" allow="fullscreen"></canvas>
    <button id="backBtn" class="back-btn" onclick="leaveServer()" style="display: none;">Leave Server</button>
    <button id="homeBtn" class="back-btn" onclick="showHome()" style="display: none;">Back to Home</button>
    <div id="ui" style="display: none;"></div>
    <div id="publicChat" style="display: none;">
        <div id="publicChatMessages"></div>
        <input id="publicChatInput" type="text" placeholder="Server chat..." onkeydown="if(event.key === 'Enter') sendPublicMessage()">
    </div>
    <div id="chatBox" style="display: none;">
        <div id="chatMessages"></div>
        <input id="chatInput" type="text" placeholder="Message friends..." onkeydown="if(event.key === 'Enter') sendMessage()">
        <button onclick="toggleChatBox()">Close</button>
    </div>
    <div id="friendBox" style="display: none;">
        <div>Friends</div>
        <input id="friendSearch" type="text" placeholder="Search players..." oninput="updateFriendSuggestions()">
        <div id="friendSuggestions"></div>
        <div id="friendList"></div>
        <div id="friendRequests"></div>
        <button onclick="sendFriendRequest()">Send Friend Request</button>
        <button onclick="toggleFriendBox()">Close</button>
    </div>
    <div id="notification"></div>
    <div id="voteBox" style="display: none;">
        <h2>Vote for Next Map</h2>
        <div id="voteOptions"></div>
        <button onclick="closeVote()">Close</button>
    </div>
    <div id="reportBox" style="display: none;">
        <h2>Report Player</h2>
        <label for="reportPlayer">Select Player:</label>
        <select id="reportPlayer" aria-label="Select player to report"></select>
        <button onclick="submitReport()">Report</button>
        <button onclick="document.getElementById('reportBox').style.display='none'">Cancel</button>
    </div>
    <div id="reviewReportsBox" style="display: none;">
        <h2>Review Reports</h2>
        <div id="reportList"></div>
        <button onclick="document.getElementById('reviewReportsBox').style.display='none'">Close</button>
    </div>
    <div id="shopBox" style="display: none;">
        <h2>Weapons Shop</h2>
        <div id="weaponList"></div>
        <button onclick="document.getElementById('shopBox').style.display='none'">Close</button>
    </div>
    <div id="skinBox" style="display: none;">
        <h2>Skins Shop</h2>
        <div id="skinList"></div>
        <button onclick="document.getElementById('skinBox').style.display='none'">Close</button>
    </div>
    <input id="restoreInput" type="file" accept=".json" style="display: none;" onchange="handleRestore(event)" title="Restore backup file">
    <label for="restoreInput" style="display: none;">Restore Backup</label>

    <script>
        try {
            console.log('Script loaded successfully');
            let version = 3.4;
            let username = null;
            let accounts = JSON.parse(localStorage.getItem('coneWorksAccounts')) || {};
            let servers = JSON.parse(localStorage.getItem('coneWorksServers')) || [];
            let reports = JSON.parse(localStorage.getItem('coneWorksReports')) || [];
            let bannedPlayers = JSON.parse(localStorage.getItem('coneWorksBannedPlayers')) || [];
            let currentServer = null;
            let conecon = 0;
            let equippedSkin = 'default-boy';
            let equippedWeapon = 'fist';
            let friends = [];
            let friendRequestsSent = [];
            let friendRequestsReceived = [];
            let messages = JSON.parse(localStorage.getItem('coneWorksMessages')) || [];
            let publicMessages = [];
            let pov = 'third';
            let skins = {
                'default-boy': { cost: 0, color: [1, 0, 0, 1] },
                'default-girl': { cost: 0, color: [1, 0.5, 0.5, 1] },
                'ninja-boy': { cost: 50, color: [0.2, 0.2, 0.2, 1] }
            };
            let weapons = {
                'fist': { cost: 0, damage: 10 },
                'sword': { cost: 20, damage: 20 }
            };
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            let ui = document.getElementById('ui');
            const coneconDisplay = document.getElementById('coneconDisplay');

            function resetData() {
                localStorage.clear();
                accounts = {};
                accounts['conehead8654'] = { password: 'Di@d09202015', friends: [], requestsSent: [], wins: 0, conecon: 100, equippedSkin: 'default-boy', equippedWeapon: 'fist' };
                servers = [];
                reports = [];
                bannedPlayers = [];
                localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                localStorage.setItem('coneWorksServers', JSON.stringify(servers));
                localStorage.setItem('coneWorksReports', JSON.stringify(reports));
                localStorage.setItem('coneWorksBannedPlayers', JSON.stringify(bannedPlayers));
                alert('Data reset! Try logging in with conehead8654.');
                console.log('Data reset');
            }

            function login() {
                try {
                    const user = document.getElementById('username').value.trim();
                    const pass = document.getElementById('password').value;
                    const userLower = user.toLowerCase();
                    let matchedUser = Object.keys(accounts).find(u => u.toLowerCase() === userLower);
                    if (matchedUser && accounts[matchedUser].password === pass) {
                        username = matchedUser;
                        conecon = accounts[matchedUser].conecon || 0;
                        equippedSkin = accounts[matchedUser].equippedSkin || 'default-boy';
                        equippedWeapon = accounts[matchedUser].equippedWeapon || 'fist';
                        friends = accounts[matchedUser].friends || [];
                        friendRequestsSent = accounts[matchedUser].requestsSent || [];
                        friendRequestsReceived = JSON.parse(localStorage.getItem('coneWorksRequestsReceived'))?.[matchedUser] || [];
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('homePage').style.display = 'block';
                        document.getElementById('fullscreenBtn').style.display = 'block';
                        document.getElementById('reviewReportsBtn').style.display = username.toLowerCase() === 'conehead8654' ? 'block' : 'none';
                        updateConeconDisplay();
                        updateFriendList();
                        console.log('Login successful:', matchedUser);
                    } else {
                        alert('Invalid username or password!');
                    }
                } catch (e) {
                    console.error('Login error:', e);
                    alert('Error logging in. Check console.');
                }
            }

            function signup() {
                try {
                    const user = document.getElementById('username').value.trim();
                    const pass = document.getElementById('password').value;
                    const userLower = user.toLowerCase();
                    if (user && pass && !Object.keys(accounts).some(u => u.toLowerCase() === userLower) && userLower !== 'conehead8654') {
                        accounts[user] = { password: pass, friends: [], requestsSent: [], wins: 0, conecon: 0, equippedSkin: 'default-boy', equippedWeapon: 'fist' };
                        localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                        username = user;
                        conecon = 0;
                        equippedSkin = 'default-boy';
                        equippedWeapon = 'fist';
                        friends = [];
                        friendRequestsSent = [];
                        friendRequestsReceived = [];
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('homePage').style.display = 'block';
                        document.getElementById('fullscreenBtn').style.display = 'block';
                        document.getElementById('reviewReportsBtn').style.display = 'none';
                        updateConeconDisplay();
                        console.log('Signup successful:', user);
                    } else {
                        alert(Object.keys(accounts).some(u => u.toLowerCase() === userLower) ? 'Username taken!' : 'Invalid username/password or reserved name!');
                    }
                } catch (e) {
                    console.error('Signup error:', e);
                    alert('Error signing up. Check console.');
                }
            }

            function toggleControls() {
                try {
                    const controlsBox = document.getElementById('controlsBox');
                    controlsBox.style.display = controlsBox.style.display === 'none' ? 'block' : 'none';
                    console.log('Toggled controls:', controlsBox.style.display);
                } catch (e) {
                    console.error('Toggle controls error:', e);
                    alert('Error showing controls. Check console.');
                }
            }

            function updateConeconDisplay() {
                coneconDisplay.textContent = `Conecons: ${conecon}`;
            }

            function showHome() {
                document.getElementById('homePage').style.display = 'block';
                document.getElementById('serverPage').style.display = 'none';
                document.getElementById('createServerPage').style.display = 'none';
                document.getElementById('settingsPage').style.display = 'none';
                document.getElementById('fullscreenBtn').style.display = 'block';
                document.getElementById('backBtn').style.display = 'none';
                document.getElementById('homeBtn').style.display = 'none';
                document.getElementById('publicChat').style.display = 'none';
                canvas.style.display = 'none';
                ui.style.display = 'none';
                document.getElementById('reviewReportsBtn').style.display = username && username.toLowerCase() === 'conehead8654' ? 'block' : 'none';
                updateFriendList();
                console.log('Returned to home page');
            }

            function loadServerPage() {
                document.getElementById('homePage').style.display = 'none';
                document.getElementById('serverPage').style.display = 'block';
                document.getElementById('fullscreenBtn').style.display = 'block';
                updateServerList();
                console.log('Loaded server page');
            }

            function loadCreateServerPage() {
                document.getElementById('homePage').style.display = 'none';
                document.getElementById('createServerPage').style.display = 'block';
                document.getElementById('fullscreenBtn').style.display = 'block';
                console.log('Loaded create server page');
            }

            function loadSettingsPage() {
                document.getElementById('homePage').style.display = 'none';
                document.getElementById('settingsPage').style.display = 'block';
                document.getElementById('fullscreenBtn').style.display = 'block';
                console.log('Loaded settings page');
            }

            function createServer() {
                try {
                    const name = document.getElementById('newServerName').value.trim();
                    const mode = document.getElementById('newServerMode').value;
                    if (name && !servers.find(s => s.name === name)) {
                        servers.push({ name, mode, players: [username], owner: username });
                        localStorage.setItem('coneWorksServers', JSON.stringify(servers));
                        joinServer(name);
                        console.log('Server created:', name, mode);
                    } else {
                        alert('Server name taken or invalid!');
                        console.log('Failed to create server:', name);
                    }
                } catch (e) {
                    console.error('Create server error:', e);
                    alert('Error creating server. Check console.');
                }
            }

            function updateServerList() {
                try {
                    const tbody = document.getElementById('serverTableBody');
                    tbody.innerHTML = '';
                    servers.forEach(s => {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${s.name}</td><td>${s.mode}</td><td>${s.players ? s.players.length : 0}</td><td><button onclick="joinServer('${s.name}')">Join</button></td>`;
                        tbody.appendChild(row);
                    });
                    console.log('Updated server list:', servers.length, 'servers');
                } catch (e) {
                    console.error('Update server list error:', e);
                    alert('Error updating server list. Check console.');
                }
            }

            function updateServerSuggestions() {
                try {
                    const search = document.getElementById('serverSearch').value.toLowerCase();
                    const mode = document.getElementById('modeFilter').value;
                    const suggestions = document.getElementById('serverSuggestions');
                    suggestions.innerHTML = '';
                    servers.filter(s => (mode === 'all' || s.mode === mode) && s.name.toLowerCase().includes(search)).slice(0, 5).forEach(s => {
                        const div = document.createElement('div');
                        div.className = 'suggestion';
                        div.textContent = s.name;
                        div.onclick = () => joinServer(s.name);
                        suggestions.appendChild(div);
                    });
                    console.log('Updated server suggestions');
                } catch (e) {
                    console.error('Update server suggestions error:', e);
                    alert('Error updating suggestions. Check console.');
                }
            }

            function joinServer(name) {
                try {
                    if (bannedPlayers.includes(username)) {
                        alert('You are banned!');
                        console.log('Join attempt blocked: user banned', username);
                        return;
                    }
                    if (name === 'random') {
                        if (servers.length === 0) {
                            alert('No servers available!');
                            console.log('No servers available for random join');
                            return;
                        }
                        currentServer = servers.reduce((max, s) => (s.players?.length || 0) > (max.players?.length || 0) ? s : max, servers[0]);
                    } else {
                        currentServer = servers.find(s => s.name === name);
                    }
                    if (currentServer) {
                        if (!currentServer.players) currentServer.players = [];
                        currentServer.players.push(username);
                        localStorage.setItem('coneWorksServers', JSON.stringify(servers));
                        document.getElementById('serverPage').style.display = 'none';
                        canvas.style.display = 'block';
                        document.getElementById('fullscreenBtn').style.display = 'block';
                        document.getElementById('backBtn').style.display = 'block';
                        document.getElementById('homeBtn').style.display = 'none';
                        document.getElementById('publicChat').style.display = 'block';
                        startGame();
                        console.log('Joined server:', currentServer.name, 'Players:', currentServer.players.length);
                    } else {
                        alert('Server not found!');
                        console.log('Server not found:', name);
                    }
                } catch (e) {
                    console.error('Join server error:', e);
                    alert('Error joining server. Check console.');
                }
            }

            function leaveServer() {
                try {
                    if (currentServer) {
                        currentServer.players = currentServer.players.filter(p => p !== username);
                        if (currentServer.players.length === 0) {
                            servers = servers.filter(s => s.name !== currentServer.name);
                        }
                        localStorage.setItem('coneWorksServers', JSON.stringify(servers));
                    }
                    currentServer = null;
                    canvas.style.display = 'none';
                    document.getElementById('fullscreenBtn').style.display = 'block';
                    document.getElementById('backBtn').style.display = 'none';
                    document.getElementById('publicChat').style.display = 'none';
                    ui.style.display = 'none';
                    showHome();
                    console.log('Left server');
                } catch (e) {
                    console.error('Leave server error:', e);
                    alert('Error leaving server. Check console.');
                }
            }

            function testUI() {
                try {
                    console.log('Testing UI rendering on home page');
                    if (!ui) {
                        ui = document.createElement('div');
                        ui.id = 'ui';
                        document.body.appendChild(ui);
                        console.log('Created new #ui div');
                    }
                    ui.style.display = 'block';
                    ui.style.position = 'fixed';
                    ui.style.top = '10px';
                    ui.style.left = '10px';
                    ui.style.zIndex = '5000';
                    ui.style.opacity = '1';
                    ui.style.visibility = 'visible';
                    ui.innerHTML = '<button id="testButton">Test Button</button>';
                    console.log('Test UI button rendered');
                    console.log('UI dimensions:', { width: ui.offsetWidth, height: ui.offsetHeight });
                    console.log('UI computed styles:', window.getComputedStyle(ui));
                    console.log('Parent styles:', window.getComputedStyle(ui.parentElement));
                    setTimeout(() => {
                        ui.style.display = 'none';
                        console.log('Test UI hidden');
                    }, 5000);
                } catch (e) {
                    console.error('Test UI error:', e);
                    alert('Error testing UI. Check console.');
                }
            }

            function testUI2() {
                try {
                    console.log('Testing UI 2 rendering directly on body');
                    const testBtn = document.createElement('button');
                    testBtn.id = 'testButton2';
                    testBtn.textContent = 'Test Button 2';
                    document.body.appendChild(testBtn);
                    testBtn.style.position = 'fixed';
                    testBtn.style.top = '100px';
                    testBtn.style.left = '10px';
                    testBtn.style.zIndex = '5000';
                    testBtn.style.background = '#ff0000';
                    testBtn.style.color = 'white';
                    testBtn.style.border = '2px solid white';
                    testBtn.style.padding = '20px';
                    testBtn.style.fontSize = '24px';
                    console.log('Test UI 2 button rendered');
                    console.log('Test Button 2 dimensions:', { width: testBtn.offsetWidth, height: testBtn.offsetHeight });
                    console.log('Test Button 2 computed styles:', window.getComputedStyle(testBtn));
                    setTimeout(() => {
                        testBtn.remove();
                        console.log('Test UI 2 button removed');
                    }, 5000);
                } catch (e) {
                    console.error('Test UI 2 error:', e);
                    alert('Error testing UI 2. Check console.');
                }
            }

            function startGame() {
                try {
                    console.log('Starting game');
                    let player = { x: 400, y: 300, z: 0, speed: 5, jumping: false, jumpHeight: 50 };
                    canvas.style.display = 'block';
                    if (!ui) {
                        console.log('UI element not found, creating new #ui div');
                        ui = document.createElement('div');
                        ui.id = 'ui';
                        document.body.appendChild(ui);
                    }
                    console.log('UI element found or created:', ui);
                    ui.style.display = 'block';
                    ui.style.position = 'fixed';
                    ui.style.top = '10px';
                    ui.style.left = '10px';
                    ui.style.zIndex = '5000';
                    ui.style.opacity = '1';
                    ui.style.visibility = 'visible';
                    try {
                        ui.innerHTML = `
                            <button onclick="openSkinShop()">Skin Shop</button>
                            <button onclick="openWeaponShop()">Weapon Shop</button>
                            <button onclick="togglePOV()">Toggle POV</button>
                            <button onclick="document.getElementById('reportBox').style.display='block'; updateReportPlayerList()">Report Player</button>
                            <button onclick="togglePlayerList()">Player List</button>
                        `;
                        console.log('UI buttons rendered: Skin Shop, Weapon Shop, Toggle POV, Report Player, Player List');
                        console.log('UI dimensions:', { width: ui.offsetWidth, height: ui.offsetHeight });
                        console.log('UI computed styles:', window.getComputedStyle(ui));
                        console.log('Parent styles:', window.getComputedStyle(ui.parentElement));
                        const buttons = ui.querySelectorAll('button');
                        if (buttons.length === 0) {
                            alert('UI buttons failed to render! Check console for styles.');
                        }
                        buttons.forEach((btn, i) => {
                            console.log(`Button ${i + 1} computed styles:`, window.getComputedStyle(btn));
                        });
                    } catch (e) {
                        console.error('Error setting ui.innerHTML:', e);
                        alert('UI buttons failed to render. Check console for errors.');
                    }
                    updateShop();
                    updateSkinShop();
                    function gameLoop() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = 'green';
                        ctx.fillRect(0, 300, canvas.width, canvas.height);
                        ctx.strokeStyle = `rgb(${skins[equippedSkin].color[0] * 255}, ${skins[equippedSkin].color[1] * 255}, ${skins[equippedSkin].color[2] * 255})`;
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.arc(player.x + 10, player.y - player.z - 5, 5, 0, Math.PI * 2);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(player.x + 10, player.y - player.z);
                        ctx.lineTo(player.x + 10, player.y - player.z + 15);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(player.x + 5, player.y - player.z + 5);
                        ctx.lineTo(player.x + 15, player.y - player.z + 5);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(player.x + 10, player.y - player.z + 15);
                        ctx.lineTo(player.x + 5, player.y - player.z + 25);
                        ctx.lineTo(player.x + 10, player.y - player.z + 15);
                        ctx.lineTo(player.x + 15, player.y - player.z + 25);
                        ctx.stroke();
                        ctx.fillStyle = 'white';
                        ctx.font = '12px Arial';
                        ctx.fillText(username, player.x, player.y - player.z - 15);
                        if (!player.jumping) {
                            player.y = Math.min(Math.max(player.y, 285), 450);
                            player.z = 0;
                        }
                        requestAnimationFrame(gameLoop);
                    }
                    document.addEventListener('keydown', e => {
                        if (document.activeElement !== document.getElementById('publicChatInput') && 
                            document.activeElement !== document.getElementById('chatInput')) {
                            if (e.key === 'w' || e.key === 'ArrowUp') {
                                player.y = Math.max(285, player.y - player.speed);
                            }
                            if (e.key === 's' || e.key === 'ArrowDown') {
                                player.y = Math.min(450, player.y + player.speed);
                            }
                            if (e.key === 'a' || e.key === 'ArrowLeft') {
                                player.x = Math.max(0, player.x - player.speed);
                            }
                            if (e.key === 'd' || e.key === 'ArrowRight') {
                                player.x = Math.min(800, player.x + player.speed);
                            }
                            if (e.key === ' ') {
                                if (!player.jumping) {
                                    player.jumping = true;
                                    let jump = 0;
                                    const currentY = player.y;
                                    const jumpInterval = setInterval(() => {
                                        jump += 5;
                                        player.z = Math.sin(jump / (player.jumpHeight * 0.8) * Math.PI) * player.jumpHeight;
                                        player.y = currentY;
                                        if (jump >= player.jumpHeight * 1.2) {
                                            player.z = 0;
                                            player.jumping = false;
                                            player.y = Math.min(Math.max(currentY, 285), 450);
                                            clearInterval(jumpInterval);
                                        }
                                    }, 10);
                                }
                            }
                            if (e.key === 'c') {
                                document.getElementById('publicChat').style.display = document.getElementById('publicChat').style.display === 'none' ? 'block' : 'none';
                                if (document.getElementById('publicChat').style.display === 'block') {
                                    document.getElementById('publicChatInput').focus();
                                }
                            }
                        }
                    });
                    gameLoop();
                    updateReportPlayerList();
                    console.log('Game started');
                } catch (e) {
                    console.error('Start game error:', e);
                    alert('Error starting game. Check console.');
                }
            }

            function openSkinShop() {
                document.getElementById('skinBox').style.display = 'block';
                updateSkinShop();
                console.log('Opened Skin Shop');
            }

            function openWeaponShop() {
                document.getElementById('shopBox').style.display = 'block';
                updateShop();
                console.log('Opened Weapon Shop');
            }

            function updateSkinShop() {
                try {
                    const skinList = document.getElementById('skinList');
                    skinList.innerHTML = '';
                    Object.keys(skins).forEach(skin => {
                        const div = document.createElement('div');
                        div.innerHTML = `${skin} (${skins[skin].cost} Conecons) <button onclick="buySkin('${skin}')">Buy</button>`;
                        skinList.appendChild(div);
                    });
                    console.log('Updated Skin Shop');
                } catch (e) {
                    console.error('Update skin shop error:', e);
                    alert('Error updating skin shop. Check console.');
                }
            }

            function buySkin(skin) {
                try {
                    if (conecon >= skins[skin].cost) {
                        conecon -= skins[skin].cost;
                        accounts[username].conecon = conecon;
                        accounts[username].equippedSkin = skin;
                        equippedSkin = skin;
                        localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                        updateConeconDisplay();
                        alert(`Purchased and equipped ${skin}!`);
                        console.log('Bought skin:', skin);
                    } else {
                        alert('Not enough Conecons!');
                    }
                } catch (e) {
                    console.error('Buy skin error:', e);
                    alert('Error buying skin. Check console.');
                }
            }

            function updateShop() {
                try {
                    const weaponList = document.getElementById('weaponList');
                    weaponList.innerHTML = '';
                    Object.keys(weapons).forEach(weapon => {
                        const div = document.createElement('div');
                        div.innerHTML = `${weapon} (${weapons[weapon].cost} Conecons) <button onclick="buyWeapon('${weapon}')">Buy</button>`;
                        weaponList.appendChild(div);
                    });
                    console.log('Updated Weapon Shop');
                } catch (e) {
                    console.error('Update weapon shop error:', e);
                    alert('Error updating weapon shop. Check console.');
                }
            }

            function buyWeapon(weapon) {
                try {
                    if (conecon >= weapons[weapon].cost) {
                        conecon -= weapons[weapon].cost;
                        accounts[username].conecon = conecon;
                        accounts[username].equippedWeapon = weapon;
                        equippedWeapon = weapon;
                        localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                        updateConeconDisplay();
                        alert(`Purchased and equipped ${weapon}!`);
                        console.log('Bought weapon:', weapon);
                    } else {
                        alert('Not enough Conecons!');
                    }
                } catch (e) {
                    console.error('Buy weapon error:', e);
                    alert('Error buying weapon. Check console.');
                }
            }

            function updateReportPlayerList() {
                try {
                    const reportPlayer = document.getElementById('reportPlayer');
                    reportPlayer.innerHTML = '';
                    const players = currentServer ? currentServer.players.filter(p => p !== username) : Object.keys(accounts).filter(u => u !== username);
                    players.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p;
                        option.textContent = p;
                        reportPlayer.appendChild(option);
                    });
                    console.log('Updated report player list:', players.length, 'players');
                } catch (e) {
                    console.error('Update report player list error:', e);
                    alert('Error updating report player list. Check console.');
                }
            }

            function submitReport() {
                try {
                    const target = document.getElementById('reportPlayer').value;
                    if (!target || target === username) {
                        alert('Invalid player selected!');
                        return;
                    }
                    const targetLogs = [...publicMessages, ...messages]
                        .filter(m => m.from === target && new Date(m.time) <= Date.now())
                        .map(m => `${m.from}: ${m.text} (${new Date(m.time).toLocaleTimeString()}) [${m.from === target ? 'Public' : 'Friend'}]`);
                    if (username.toLowerCase() === 'conehead8654') {
                        bannedPlayers.push(target);
                        if (currentServer) {
                            currentServer.players = currentServer.players.filter(p => p !== target);
                            if (currentServer.players.length === 0) {
                                servers = servers.filter(s => s.name !== currentServer.name);
                            }
                        }
                        servers.forEach(s => s.players = s.players.filter(p => p !== target));
                        localStorage.setItem('coneWorksBannedPlayers', JSON.stringify(bannedPlayers));
                        localStorage.setItem('coneWorksServers', JSON.stringify(servers));
                        alert(`Player ${target} banned from all servers!\nChat Logs:\n${targetLogs.join('\n') || 'No logs found'}`);
                        console.log('Banned player:', target);
                    } else {
                        reports.push({ reporter: username, target, logs: targetLogs, time: new Date().toISOString() });
                        localStorage.setItem('coneWorksReports', JSON.stringify(reports));
                        alert(`Report sent for ${target}! Admin will review.`);
                        console.log('Report submitted:', { reporter: username, target });
                    }
                    document.getElementById('reportBox').style.display = 'none';
                } catch (e) {
                    console.error('Submit report error:', e);
                    alert('Error submitting report. Check console.');
                }
            }

            function reviewReports() {
                try {
                    if (username.toLowerCase() !== 'conehead8654') {
                        alert('Only conehead8654 can review reports!');
                        return;
                    }
                    const reportList = document.getElementById('reportList');
                    reportList.innerHTML = '';
                    reports.forEach((r, index) => {
                        const div = document.createElement('div');
                        div.style.marginBottom = '10px';
                        div.innerHTML = `
                            <p>Reporter: ${r.reporter}</p>
                            <p>Target: ${r.target}</p>
                            <p>Time: ${new Date(r.time).toLocaleString()}</p>
                            <p>Logs:</p>
                            <div>${r.logs.join('<br>') || 'No logs found'}</div>
                            <button onclick="banPlayer(${index})">Ban</button>
                            <button onclick="ignoreReport(${index})">Ignore</button>
                        `;
                        reportList.appendChild(div);
                    });
                    document.getElementById('reviewReportsBox').style.display = 'block';
                    console.log('Opened review reports');
                } catch (e) {
                    console.error('Review reports error:', e);
                    alert('Error reviewing reports. Check console.');
                }
            }

            function banPlayer(reportIndex) {
                try {
                    const report = reports[reportIndex];
                    bannedPlayers.push(report.target);
                    if (currentServer) {
                        currentServer.players = currentServer.players.filter(p => p !== report.target);
                        if (currentServer.players.length === 0) {
                            servers = servers.filter(s => s.name !== currentServer.name);
                        }
                    }
                    servers.forEach(s => s.players = s.players.filter(p => p !== report.target));
                    reports.splice(reportIndex, 1);
                    localStorage.setItem('coneWorksBannedPlayers', JSON.stringify(bannedPlayers));
                    localStorage.setItem('coneWorksReports', JSON.stringify(reports));
                    localStorage.setItem('coneWorksServers', JSON.stringify(servers));
                    alert(`Player ${report.target} banned from all servers!`);
                    console.log('Banned player from report:', report.target);
                    reviewReports();
                } catch (e) {
                    console.error('Ban player error:', e);
                    alert('Error banning player. Check console.');
                }
            }

            function ignoreReport(reportIndex) {
                try {
                    reports.splice(reportIndex, 1);
                    localStorage.setItem('coneWorksReports', JSON.stringify(reports));
                    alert('Report ignored.');
                    console.log('Ignored report:', reportIndex);
                    reviewReports();
                } catch (e) {
                    console.error('Ignore report error:', e);
                    alert('Error ignoring report. Check console.');
                }
            }

            function togglePOV() {
                pov = pov === 'third' ? 'first' : 'third';
                console.log('Toggled POV to:', pov);
            }

            function toggleFullscreen() {
                try {
                    if (!document.fullscreenEnabled) {
                        alert('Fullscreen not allowed by browser settings. Check browser permissions or try another browser.');
                        return;
                    }
                    if (!document.fullscreenElement) {
                        if (canvas.style.display === 'block') {
                            canvas.requestFullscreen().catch(e => {
                                console.error('Fullscreen error:', e);
                                alert('Failed to enter fullscreen. Check browser settings.');
                            });
                        } else {
                            document.documentElement.requestFullscreen().catch(e => {
                                console.error('Fullscreen error:', e);
                                alert('Failed to enter fullscreen. Check browser settings.');
                            });
                        }
                    } else {
                        document.exitFullscreen().catch(e => {
                            console.error('Exit fullscreen error:', e);
                            alert('Failed to exit fullscreen. Check browser settings.');
                        });
                    }
                } catch (e) {
                    console.error('Fullscreen toggle error:', e);
                    alert('Error toggling fullscreen. Check console.');
                }
            }

            function toggleChatBox() {
                const chatBox = document.getElementById('chatBox');
                chatBox.style.display = chatBox.style.display === 'none' ? 'block' : 'none';
                updateFriendList();
            }

            function toggleFriendBox() {
                const friendBox = document.getElementById('friendBox');
                friendBox.style.display = friendBox.style.display === 'none' ? 'block' : 'none';
                updateFriendSuggestions();
                updateFriendList();
            }

            function togglePlayerList() {
                const playerListBox = document.getElementById('playerListBox');
                playerListBox.style.display = playerListBox.style.display === 'none' ? 'block' : 'none';
                updatePlayerList();
            }

            function updateFriendSuggestions() {
                try {
                    const search = document.getElementById('friendSearch').value.toLowerCase();
                    const suggestions = document.getElementById('friendSuggestions');
                    suggestions.innerHTML = '';
                    Object.keys(accounts).filter(u => u !== username && u.toLowerCase().includes(search) && !friends.includes(u)).slice(0, 5).forEach(u => {
                        const div = document.createElement('div');
                        div.className = 'suggestion';
                        div.textContent = u;
                        div.onclick = () => document.getElementById('friendSearch').value = u;
                        suggestions.appendChild(div);
                    });
                    console.log('Updated friend suggestions');
                } catch (e) {
                    console.error('Update friend suggestions error:', e);
                    alert('Error updating friend suggestions. Check console.');
                }
            }

            function sendFriendRequest() {
                try {
                    const target = document.getElementById('friendSearch').value.trim();
                    if (target && accounts[target] && target !== username && !friends.includes(target) && !friendRequestsSent.includes(target)) {
                        friendRequestsSent.push(target);
                        accounts[username].requestsSent = friendRequestsSent;
                        let received = JSON.parse(localStorage.getItem('coneWorksRequestsReceived')) || {};
                        received[target] = received[target] || [];
                        received[target].push(username);
                        localStorage.setItem('coneWorksRequestsReceived', JSON.stringify(received));
                        localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                        alert(`Friend request sent to ${target}!`);
                        updateFriendList();
                        console.log('Friend request sent to:', target);
                    } else {
                        alert('Invalid user or request already sent!');
                    }
                } catch (e) {
                    console.error('Send friend request error:', e);
                    alert('Error sending friend request. Check console.');
                }
            }

            function acceptFriendRequest(target) {
                try {
                    if (friendRequestsReceived.includes(target)) {
                        friends.push(target);
                        accounts[username].friends = friends;
                        friendRequestsReceived = friendRequestsReceived.filter(u => u !== target);
                        let received = JSON.parse(localStorage.getItem('coneWorksRequestsReceived')) || {};
                        received[username] = friendRequestsReceived;
                        localStorage.setItem('coneWorksRequestsReceived', JSON.stringify(received));
                        localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                        alert(`Friend request from ${target} accepted!`);
                        updateFriendList();
                        console.log('Accepted friend request from:', target);
                    }
                } catch (e) {
                    console.error('Accept friend request error:', e);
                    alert('Error accepting friend request. Check console.');
                }
            }

            function rejectFriendRequest(target) {
                try {
                    if (friendRequestsReceived.includes(target)) {
                        friendRequestsReceived = friendRequestsReceived.filter(u => u !== target);
                        let received = JSON.parse(localStorage.getItem('coneWorksRequestsReceived')) || {};
                        received[username] = friendRequestsReceived;
                        localStorage.setItem('coneWorksRequestsReceived', JSON.stringify(received));
                        alert(`Friend request from ${target} rejected!`);
                        updateFriendList();
                        console.log('Rejected friend request from:', target);
                    }
                } catch (e) {
                    console.error('Reject friend request error:', e);
                    alert('Error rejecting friend request. Check console.');
                }
            }

            function updateFriendList() {
                try {
                    const friendList = document.getElementById('friendList');
                    friendList.innerHTML = '<h3>Friends</h3>' + (friends.length ? friends.map(f => `<div>${f}</div>`).join('') : '<div>No friends yet</div>');
                    const friendRequests = document.getElementById('friendRequests');
                    friendRequests.innerHTML = '<h3>Friend Requests</h3>' + (friendRequestsReceived.length ? friendRequestsReceived.map(r => `<div>${r} <button onclick="acceptFriendRequest('${r}')">Accept</button><button onclick="rejectFriendRequest('${r}')">Reject</button></div>`).join('') : '<div>No pending requests</div>');
                    console.log('Updated friend list and requests');
                } catch (e) {
                    console.error('Update friend list error:', e);
                    alert('Error updating friend list. Check console.');
                }
            }

            function updatePlayerList() {
                try {
                    const tbody = document.getElementById('playerList');
                    tbody.innerHTML = '';
                    Object.keys(accounts).filter(u => u !== username).forEach(u => {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${u}</td><td>${accounts[u].wins || 0}</td><td>${accounts[u].conecon || 0}</td><td><button onclick="sendFriendRequestTo('${u}')">Add Friend</button></td>`;
                        tbody.appendChild(row);
                    });
                    console.log('Updated player list');
                } catch (e) {
                    console.error('Update player list error:', e);
                    alert('Error updating player list. Check console.');
                }
            }

            function sendFriendRequestTo(user) {
                document.getElementById('friendSearch').value = user;
                sendFriendRequest();
            }

            function sendMessage() {
                const msg = document.getElementById('chatInput').value.trim();
                if (msg) {
                    messages.push({ from: username, text: msg, time: new Date().toISOString() });
                    localStorage.setItem('coneWorksMessages', JSON.stringify(messages));
                    document.getElementById('chatInput').value = '';
                    updateChat();
                }
            }

            function sendPublicMessage() {
                const msg = document.getElementById('publicChatInput').value.trim();
                if (msg) {
                    publicMessages.push({ from: username, text: msg, time: new Date().toISOString() });
                    document.getElementById('publicChatInput').value = '';
                    updatePublicChat();
                }
            }

            function updateChat() {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = messages.map(m => `<div>${m.from}: ${m.text} (${new Date(m.time).toLocaleTimeString()})</div>`).join('');
            }

            function updatePublicChat() {
                const publicChatMessages = document.getElementById('publicChatMessages');
                publicChatMessages.innerHTML = publicMessages.map(m => `<div>${m.from}: ${m.text} (${new Date(m.time).toLocaleTimeString()})</div>`).join('');
                publicChatMessages.scrollTop = publicChatMessages.scrollHeight;
            }

            function saveSettings() {
                const pov = document.getElementById('defaultPOV').value;
                const sensitivity = document.getElementById('mouseSensitivity').value;
                const currency = document.getElementById('currencyDisplay').value;
                localStorage.setItem('coneWorksDefaultPOV', pov);
                localStorage.setItem('coneWorksMouseSensitivity', sensitivity);
                localStorage.setItem('coneWorksCurrencyDisplay', currency);
                alert('Settings saved!');
            }

            function backupData() {
                const data = {
                    accounts: localStorage.getItem('coneWorksAccounts'),
                    messages: localStorage.getItem('coneWorksMessages'),
                    servers: localStorage.getItem('coneWorksServers'),
                    reports: localStorage.getItem('coneWorksReports'),
                    bannedPlayers: localStorage.getItem('coneWorksBannedPlayers'),
                    settings: {
                        pov: localStorage.getItem('coneWorksDefaultPOV'),
                        sensitivity: localStorage.getItem('coneWorksMouseSensitivity'),
                        currency: localStorage.getItem('coneWorksCurrencyDisplay')
                    }
                };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'coneWorksBackup.json';
                a.click();
                URL.revokeObjectURL(url);
                alert('Data backed up!');
            }

            function restoreData() {
                document.getElementById('restoreInput').click();
            }

            function handleRestore(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.accounts) localStorage.setItem('coneWorksAccounts', data.accounts);
                            if (data.messages) localStorage.setItem('coneWorksMessages', data.messages);
                            if (data.servers) localStorage.setItem('coneWorksServers', data.servers);
                            if (data.reports) localStorage.setItem('coneWorksReports', data.reports);
                            if (data.bannedPlayers) localStorage.setItem('coneWorksBannedPlayers', data.bannedPlayers);
                            if (data.settings) {
                                if (data.settings.pov) localStorage.setItem('coneWorksDefaultPOV', data.settings.pov);
                                if (data.settings.sensitivity) localStorage.setItem('coneWorksMouseSensitivity', data.settings.sensitivity);
                                if (data.settings.currency) localStorage.setItem('coneWorksCurrencyDisplay', data.settings.currency);
                            }
                            accounts = JSON.parse(localStorage.getItem('coneWorksAccounts')) || {};
                            messages = JSON.parse(localStorage.getItem('coneWorksMessages')) || [];
                            servers = JSON.parse(localStorage.getItem('coneWorksServers')) || [];
                            reports = JSON.parse(localStorage.getItem('coneWorksReports')) || [];
                            bannedPlayers = JSON.parse(localStorage.getItem('coneWorksBannedPlayers')) || [];
                            alert('Data restored! Try logging in.');
                            console.log('Data restored');
                        } catch (e) {
                            console.error('Restore error:', e);
                            alert('Error restoring data. Check console.');
                        }
                    };
                    reader.readAsText(file);
                }
            }

            function deleteAccount() {
                try {
                    const user = document.getElementById('deleteUsername').value.trim();
                    const pass = document.getElementById('deletePassword').value;
                    const userLower = user.toLowerCase();
                    const matchedUser = Object.keys(accounts).find(u => u.toLowerCase() === userLower);
                    if (matchedUser && matchedUser === username && accounts[matchedUser].password === pass) {
                        delete accounts[matchedUser];
                        localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                        username = null;
                        document.getElementById('deleteAccountBox').style.display = 'none';
                        document.getElementById('settingsPage').style.display = 'none';
                        document.getElementById('loginPage').style.display = 'block';
                        document.getElementById('fullscreenBtn').style.display = 'block';
                        alert('Account deleted!');
                        console.log('Account deleted:', matchedUser);
                    } else {
                        alert('Invalid username or password!');
                    }
                } catch (e) {
                    console.error('Delete account error:', e);
                    alert('Error deleting account. Check console.');
                }
            }

            function showDeleteAccount() {
                document.getElementById('deleteAccountBox').style.display = 'block';
                document.getElementById('fullscreenBtn').style.display = 'block';
            }

            function testMultiplayer() {
                try {
                    publicMessages = [];
                    player = { x: 400, y: 300, z: 0, speed: 5, jumping: false, jumpHeight: 50 };
                    document.getElementById('homePage').style.display = 'none';
                    canvas.style.display = 'block';
                    document.getElementById('fullscreenBtn').style.display = 'block';
                    document.getElementById('backBtn').style.display = 'none';
                    document.getElementById('homeBtn').style.display = 'block';
                    document.getElementById('publicChat').style.display = 'block';
                    startGame();
                    console.log('Started Test Multiplayer');
                } catch (e) {
                    console.error('Test Multiplayer error:', e);
                    alert('Error starting Test Multiplayer. Check console.');
                }
            }

            function closeVote() {
                document.getElementById('voteBox').style.display = 'none';
            }

            // Initialize
            if (!accounts['conehead8654']) {
                accounts['conehead8654'] = { password: 'Di@d09202015', friends: [], requestsSent: [], wins: 0, conecon: 100, equippedSkin: 'default-boy', equippedWeapon: 'fist' };
                localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
            }
            document.getElementById('versionDisplay').textContent = `Version ${version}`;
            document.getElementById('fullscreenBtn').style.display = 'block';
            updateConeconDisplay();
            updateFriendList();
            console.log('Game initialized, version:', version);
        } catch (e) {
            console.error('Script initialization error:', e);
            alert('Error loading game. Check console.');
        }
    </script>
</body>
</html>
