<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConeWorks</title>
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }
        h1 {
            font-size: 3.5em;
            text-shadow: 0 0 10px #00ffcc;
            margin-bottom: 10px;
        }
        p {
            font-size: 1.2em;
            max-width: 600px;
            text-align: center;
            margin-bottom: 20px;
        }
        .login-container, .game-buttons, .settings-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        .game-buttons { flex-direction: row; flex-wrap: wrap; }
        input, button, select {
            padding: 10px;
            font-size: 1.1em;
            border: none;
            border-radius: 5px;
        }
        input, select {
            width: 200px;
            background: #fff;
            color: #333;
        }
        button {
            background: linear-gradient(to right, #ff6b6b, #ff8e53);
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        canvas {
            display: none;
            border: 3px solid #00ffcc;
            border-radius: 10px;
            background: #000;
        }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 5px;
        }
        #publicChat {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 300px;
            height: 150px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            font-size: 14px;
            overflow-y: auto;
            display: none;
        }
        #publicChatInput {
            width: 280px;
            margin-top: 5px;
        }
        #chatBox {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            display: none;
            font-size: 14px;
            overflow-y: auto;
        }
        #chatInput {
            width: 380px;
            margin-top: 5px;
        }
        #friendBox {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 250px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            display: none;
            font-size: 14px;
        }
        #friendSearch, #serverSearch, #newServerName {
            width: 220px;
            margin-bottom: 5px;
        }
        #friendSuggestions, #serverSuggestions {
            max-height: 100px;
            overflow-y: auto;
            background: #333;
            border-radius: 5px;
        }
        .suggestion {
            padding: 5px;
            cursor: pointer;
        }
        .suggestion:hover {
            background: #555;
        }
        #notification {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: #00ffcc;
            color: #000;
            padding: 10px;
            border-radius: 5px;
            display: none;
            max-width: 300px;
        }
        #voteBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        #reportBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        #shopBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        #skinBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        .back-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px 20px;
            background: #f44336;
            color: white;
        }
        .back-btn:hover {
            background: #da190b;
        }
        #fullscreenBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10;
        }
        #coneconDisplay {
            position: absolute;
            top: 10px;
            font-size: 20px;
            color: yellow;
        }
        #controlsBox {
            display: none;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            text-align: left;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div id="loginPage">
        <h1>ConeWorks</h1>
        <p>Sign in or create an account to brawl, chill, and moderate across schools!</p>
        <div class="login-container">
            <input id="username" type="text" placeholder="Username">
            <input id="password" type="password" placeholder="Password">
            <button onclick="login()">Login</button>
            <button onclick="signup()">Sign Up</button>
            <button onclick="toggleControls()">Show Controls</button>
            <div id="controlsBox">
                <h3>Controls</h3>
                <ul>
                    <li><b>WASD</b>: Move (camera-relative)</li>
                    <li><b>Space</b>: Jump</li>
                    <li><b>E</b>: Attack (Fight mode)</li>
                    <li><b>O</b>: Toggle POV (first/third-person)</li>
                    <li><b>C</b>: Toggle server chat</li>
                    <li><b>R</b>: Report/ban player (Conehead8654 only)</li>
                    <li><b>P</b>: Open weapon shop</li>
                    <li><b>K</b>: Open skin shop</li>
                </ul>
            </div>
        </div>
    </div>
    <div id="homePage" style="display: none;">
        <div id="coneconDisplay"></div>
        <h1>ConeWorks</h1>
        <p>Create or join epic servers to brawl or chill. Unblocked for Trinity Heights.</p>
        <div class="game-buttons">
            <button onclick="loadServerPage()">Join Server</button>
            <button onclick="loadCreateServerPage()">Create Server</button>
            <button onclick="toggleChatBox()">Chat & Friends</button>
            <button onclick="loadSettingsPage()">Settings</button>
        </div>
        <p>Earn 1 Conecon per minute in-game to buy skins and weapons!</p>
    </div>
    <div id="serverPage" style="display: none;">
        <h1>Join a Server</h1>
        <p>Search for a server or join a random one!</p>
        <input id="serverSearch" type="text" placeholder="Search servers..." oninput="updateServerSuggestions()">
        <select id="modeFilter">
            <option value="all">All Modes</option>
            <option value="fight">Fight</option>
            <option value="chill">Chill</option>
        </select>
        <div id="serverSuggestions"></div>
        <div class="game-buttons">
            <button onclick="joinServer('random')">Join Random</button>
            <button onclick="joinServer(document.getElementById('serverSearch').value)">Join Server</button>
            <button onclick="showHome()">Back</button>
        </div>
    </div>
    <div id="createServerPage" style="display: none;">
        <h1>Create a Server</h1>
        <p>Choose a name and mode for your server!</p>
        <input id="newServerName" type="text" placeholder="Server Name">
        <select id="newServerMode">
            <option value="fight">Fight</option>
            <option value="chill">Chill</option>
        </select>
        <div class="game-buttons">
            <button onclick="createServer()">Create</button>
            <button onclick="showHome()">Back</button>
        </div>
    </div>
    <div id="settingsPage" style="display: none;">
        <h1>Settings</h1>
        <p>Customize your ConeWorks experience.</p>
        <div class="settings-container">
            <label for="defaultPOV">Default POV on Join:</label>
            <select id="defaultPOV">
                <option value="third">Third-Person</option>
                <option value="first">First-Person</option>
            </select>
            <label for="mouseSensitivity">Mouse Sensitivity:</label>
            <input type="range" id="mouseSensitivity" min="0.001" max="0.01" step="0.001" value="0.002">
            <label for="currencyDisplay">Currency Display:</label>
            <select id="currencyDisplay">
                <option value="top-left">Top-Left</option>
                <option value="top-right">Top-Right</option>
            </select>
            <button onclick="saveSettings()">Save</button>
            <button onclick="showHome()">Back</button>
        </div>
    </div>
    <canvas id="canvas" width="800" height="600"></canvas>
    <button id="fullscreenBtn" onclick="toggleFullscreen()" style="display: none;">Fullscreen</button>
    <button id="backBtn" class="back-btn" onclick="leaveServer()" style="display: none;">Leave Server</button>
    <div id="ui" style="display: none;"></div>
    <div id="publicChat" style="display: none;">
        <div id="publicChatMessages"></div>
        <input id="publicChatInput" type="text" placeholder="Server chat..." onkeydown="if(event.key === 'Enter') sendPublicMessage()">
    </div>
    <div id="chatBox" style="display: none;">
        <div id="chatMessages"></div>
        <input id="chatInput" type="text" placeholder="Message friends..." onkeydown="if(event.key === 'Enter') sendMessage()">
        <button onclick="toggleChatBox()">Close</button>
    </div>
    <div id="friendBox" style="display: none;">
        <div>Friends</div>
        <input id="friendSearch" type="text" placeholder="Search players..." oninput="updateFriendSuggestions()">
        <div id="friendSuggestions"></div>
        <div id="friendList"></div>
        <div id="friendRequests"></div>
        <button onclick="toggleFriendBox()">Close</button>
    </div>
    <div id="notification"></div>
    <div id="voteBox" style="display: none;">
        <h2>Vote for Next Map</h2>
        <div id="voteOptions"></div>
        <button onclick="closeVote()">Close</button>
    </div>
    <div id="reportBox" style="display: none;">
        <h2>Report Player</h2>
        <select id="reportPlayer"></select>
        <button onclick="submitReport()">Report</button>
        <button onclick="document.getElementById('reportBox').style.display='none'">Cancel</button>
    </div>
    <div id="shopBox" style="display: none;">
        <h2>Weapons Shop</h2>
        <div id="weaponList"></div>
        <button onclick="document.getElementById('shopBox').style.display='none'">Close</button>
    </div>
    <div id="skinBox" style="display: none;">
        <h2>Skins Shop</h2>
        <div id="skinList"></div>
        <button onclick="document.getElementById('skinBox').style.display='none'">Close</button>
    </div>

    <script>
        // State
        let currentGame = null;
        let currentServer = null;
        let serverOwner = null;
        let username = null;
        let accounts = JSON.parse(localStorage.getItem('coneWorksAccounts')) || {};
        let friends = [];
        let friendRequestsSent = [];
        let friendRequestsReceived = [];
        let messages = JSON.parse(localStorage.getItem('coneWorksMessages')) || [];
        let publicMessages = [];
        let servers = JSON.parse(localStorage.getItem('coneWorksServers')) || [
            { name: 'TrinityBrawl', mode: 'fight', owner: 'Ninja123' },
            { name: 'NeonArena', mode: 'fight', owner: 'ParkourPro' },
            { name: 'StarFight', mode: 'fight', owner: 'BrawlMaster' },
            { name: 'ConeChill', mode: 'chill', owner: 'SpeedyCone' }
        ];
        let players = {};
        let map = 'Arena';
        let mapVotes = { Arena: 0, Rooftop: 0, 'Space Station': 0 };
        let mapTimer = 30 * 60 * 1000;
        let lastMapSwitch = Date.now();
        let firstPerson = false;
        let defaultPOV = localStorage.getItem('coneWorksDefaultPOV') || 'third';
        let mouseSensitivity = parseFloat(localStorage.getItem('coneWorksMouseSensitivity')) || 0.002;
        let currencyDisplay = localStorage.getItem('coneWorksCurrencyDisplay') || 'top-left';
        let yaw = 0, pitch = 0;
        let serverMode = 'fight';
        let conecon = parseInt(localStorage.getItem('coneWorksConecon')) || 0;
        let equippedSkin = 'default-boy';
        let equippedWeapon = 'fist';
        let skins = {
            'default-boy': { cost: 0, color: [1, 0, 0, 1] },
            'default-girl': { cost: 0, color: [1, 0.5, 0.5, 1] },
            'ninja-boy': { cost: 50, color: [0.2, 0.2, 0.2, 1] },
            'princess-girl': { cost: 75, color: [1, 0.8, 0.8, 1] },
            'robot-boy': { cost: 100, color: [0.5, 0.5, 0.5, 1] },
            'warrior-girl': { cost: 150, color: [0.7, 0.2, 0.2, 1] }
        };
        let weapons = {
            'fist': { cost: 0, damage: 10 },
            'sword': { cost: 20, damage: 20 },
            'gun': { cost: 50, damage: 30 },
            'laser': { cost: 100, damage: 40 }
        };
        let currencyTimer = Date.now();
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) {
            alert('WebGL not supported. Try Chrome in incognito mode or a different browser.');
        }
        const ui = document.getElementById('ui');
        const publicChat = document.getElementById('publicChat');
        const publicChatMessages = document.getElementById('publicChatMessages');
        const publicChatInput = document.getElementById('publicChatInput');
        const chatBox = document.getElementById('chatBox');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const friendBox = document.getElementById('friendBox');
        const friendSearch = document.getElementById('friendSearch');
        const friendSuggestions = document.getElementById('friendSuggestions');
        const friendList = document.getElementById('friendList');
        const friendRequests = document.getElementById('friendRequests');
        const notification = document.getElementById('notification');
        const voteBox = document.getElementById('voteBox');
        const voteOptions = document.getElementById('voteOptions');
        const reportBox = document.getElementById('reportBox');
        const reportPlayer = document.getElementById('reportPlayer');
        const shopBox = document.getElementById('shopBox');
        const skinBox = document.getElementById('skinBox');
        const coneconDisplay = document.getElementById('coneconDisplay');
        let publicChatVisible = true;

        // Login & Signup
        function login() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value;
            if (accounts[user] && accounts[user].password === pass) {
                username = user;
                friends = accounts[user].friends || [];
                friendRequestsSent = accounts[user].requestsSent || [];
                friendRequestsReceived = JSON.parse(localStorage.getItem('coneWorksRequestsReceived'))?.[user] || [];
                conecon = accounts[user].conecon || 0;
                equippedSkin = accounts[user].equippedSkin || 'default-boy';
                equippedWeapon = accounts[user].equippedWeapon || 'fist';
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('homePage').style.display = 'block';
                updateFriends();
                updateChat();
                updateConeconDisplay();
            } else {
                alert('Invalid username or password!');
            }
        }

        function signup() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value;
            if (user && pass && !accounts[user] && user !== 'Conehead8654') {
                accounts[user] = { password: pass, friends: [], requestsSent: [], wins: 0, conecon: 0, equippedSkin: 'default-boy', equippedWeapon: 'fist' };
                localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                username = user;
                friends = [];
                friendRequestsSent = [];
                friendRequestsReceived = [];
                conecon = 0;
                equippedSkin = 'default-boy';
                equippedWeapon = 'fist';
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('homePage').style.display = 'block';
                updateFriends();
                updateChat();
                updateConeconDisplay();
            } else if (user === 'Conehead8654') {
                alert('Username "Conehead8654" is reserved!');
            } else {
                alert(accounts[user] ? 'Username taken!' : 'Enter a valid username and password!');
            }
        }

        // Conecon Display
        function updateConeconDisplay() {
            coneconDisplay.style.left = currencyDisplay === 'top-left' ? '10px' : '';
            coneconDisplay.style.right = currencyDisplay === 'top-right' ? '10px' : '';
            coneconDisplay.textContent = `Conecon: ${conecon}`;
        }

        // Controls
        function toggleControls() {
            const controlsBox = document.getElementById('controlsBox');
            controlsBox.style.display = controlsBox.style.display === 'none' ? 'block' : 'none';
        }

        // Friends
        function updateFriends() {
            friendList.innerHTML = friends.length
                ? friends.map(f => `<div>${f} <button onclick="removeFriend('${f}')">Remove</button></div>`).join('')
                : 'No friends yet!';
            friendRequests.innerHTML = friendRequestsReceived.length
                ? friendRequestsReceived.map(r => `<div>${r.from} <button onclick="acceptFriend('${r.from}')">Accept</button> <button onclick="rejectFriend('${r.from}')">Reject</button></div>`).join('')
                : 'No friend requests!';
        }

        function updateFriendSuggestions() {
            const query = friendSearch && friendSearch.value ? friendSearch.value.toLowerCase().trim() : '';
            friendSuggestions.innerHTML = query ? Object.keys(accounts)
                .filter(p => p.toLowerCase().includes(query) && p !== username && !friends.includes(p) && !friendRequestsSent.includes(p))
                .map(p => `<div class="suggestion" onclick="friendSearch.value='${p}'; friendSuggestions.innerHTML=''">${p}</div>`)
                .join('') : '';
        }

        function sendFriendRequest() {
            const target = friendSearch && friendSearch.value ? friendSearch.value.trim() : '';
            if (target && target !== username && accounts[target] && !friends.includes(target) && !friendRequestsSent.includes(target)) {
                friendRequestsSent.push(target);
                accounts[username].requestsSent = friendRequestsSent;
                let received = JSON.parse(localStorage.getItem('coneWorksRequestsReceived')) || {};
                received[target] = received[target] || [];
                received[target].push({ from: username, to: target });
                localStorage.setItem('coneWorksRequestsReceived', JSON.stringify(received));
                localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                friendSearch.value = '';
                friendSuggestions.innerHTML = '';
                updateFriends();
                alert(`Friend request sent to ${target}!`);
            } else {
                alert('Player Not Found!');
            }
        }

        function acceptFriend(from) {
            friends.push(from);
            accounts[username].friends = friends;
            let received = JSON.parse(localStorage.getItem('coneWorksRequestsReceived')) || {};
            received[username] = received[username]?.filter(r => r.from !== from) || [];
            localStorage.setItem('coneWorksRequestsReceived', JSON.stringify(received));
            localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
            updateFriends();
        }

        function rejectFriend(from) {
            let received = JSON.parse(localStorage.getItem('coneWorksRequestsReceived')) || {};
            received[username] = received[username]?.filter(r => r.from !== from) || [];
            localStorage.setItem('coneWorksRequestsReceived', JSON.stringify(received));
            updateFriends();
        }

        function removeFriend(friend) {
            friends = friends.filter(f => f !== friend);
            accounts[username].friends = friends;
            localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
            updateFriends();
        }

        // Navigation
        function showHome() {
            currentGame = null;
            currentServer = null;
            serverOwner = null;
            canvas.style.display = 'none';
            ui.style.display = 'none';
            publicChat.style.display = 'none';
            chatBox.style.display = 'none';
            friendBox.style.display = 'none';
            voteBox.style.display = 'none';
            reportBox.style.display = 'none';
            shopBox.style.display = 'none';
            skinBox.style.display = 'none';
            document.getElementById('fullscreenBtn').style.display = 'none';
            document.getElementById('backBtn').style.display = 'none';
            document.getElementById('homePage').style.display = 'block';
            document.getElementById('serverPage').style.display = 'none';
            document.getElementById('createServerPage').style.display = 'none';
            document.getElementById('settingsPage').style.display = 'none';
            updateChat();
            updateFriends();
            updateConeconDisplay();
        }

        function loadServerPage() {
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('serverPage').style.display = 'block';
            updateServerSuggestions();
        }

        function loadCreateServerPage() {
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('createServerPage').style.display = 'block';
        }

        function loadSettingsPage() {
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('settingsPage').style.display = 'block';
            document.getElementById('defaultPOV').value = defaultPOV;
            document.getElementById('mouseSensitivity').value = mouseSensitivity;
            document.getElementById('currencyDisplay').value = currencyDisplay;
        }

        function saveSettings() {
            defaultPOV = document.getElementById('defaultPOV').value;
            mouseSensitivity = parseFloat(document.getElementById('mouseSensitivity').value);
            currencyDisplay = document.getElementById('currencyDisplay').value;
            localStorage.setItem('coneWorksDefaultPOV', defaultPOV);
            localStorage.setItem('coneWorksMouseSensitivity', mouseSensitivity);
            localStorage.setItem('coneWorksCurrencyDisplay', currencyDisplay);
            showHome();
        }

        // Currency
        function updateCurrency() {
            if (currentGame === 'game') {
                if (Date.now() - currencyTimer >= 60000) {
                    conecon += 1;
                    accounts[username].conecon = conecon;
                    localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                    currencyTimer = Date.now();
                    updateConeconDisplay();
                }
            }
        }

        // Fullscreen
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                canvas.requestFullscreen();
                document.getElementById('fullscreenBtn').textContent = 'Exit Fullscreen';
            } else {
                document.exitFullscreen();
                document.getElementById('fullscreenBtn').textContent = 'Fullscreen';
            }
        }

        // Chat
        function toggleChatBox() {
            chatBox.style.display = chatBox.style.display === 'none' ? 'block' : 'none';
            friendBox.style.display = 'none';
            updateChat();
        }

        function toggleFriendBox() {
            friendBox.style.display = friendBox.style.display === 'none' ? 'block' : 'none';
            chatBox.style.display = 'none';
            updateFriends();
        }

        function sendMessage() {
            const text = chatInput && chatInput.value ? chatInput.value.trim() : '';
            if (text && friends.length) {
                messages.push({ from: username, text, timestamp: Date.now() });
                localStorage.setItem('coneWorksMessages', JSON.stringify(messages));
                friends.forEach(f => {
                    let received = JSON.parse(localStorage.getItem('coneWorksRequestsReceived')) || {};
                    if (accounts[f]) {
                        received[f] = received[f] || [];
                        received[f].push({ from: username, message: text });
                    }
                    localStorage.setItem('coneWorksRequestsReceived', JSON.stringify(received));
                });
                chatInput.value = '';
                updateChat();
            }
        }

        function updateChat() {
            let received = JSON.parse(localStorage.getItem('coneWorksRequestsReceived')) || {};
            let unread = received[username]?.filter(r => r.message && friends.includes(r.from)) || [];
            if (unread.length && chatBox.style.display !== 'block') {
                notification.style.display = 'block';
                notification.innerHTML = unread.map(r => `${r.from}: ${r.message}`).join('<br>');
                setTimeout(() => notification.style.display = 'none', 5000);
            }
            chatMessages.innerHTML = messages
                .filter(m => friends.includes(m.from) || m.from === username)
                .sort((a, b) => b.timestamp - a.timestamp)
                .map(m => `<div>${m.from}: ${m.text}</div>`)
                .join('');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendPublicMessage() {
            const text = publicChatInput && publicChatInput.value ? publicChatInput.value.trim() : '';
            if (text && currentServer) {
                publicMessages.push({ from: username, text, server: currentServer });
                publicChatInput.value = '';
                updatePublicChat();
            }
        }

        function updatePublicChat() {
            publicChatMessages.innerHTML = publicMessages
                .filter(m => m.server === currentServer)
                .map(m => `<div>${m.from}: ${m.text}</div>`)
                .join('');
            publicChatMessages.scrollTop = publicChatMessages.scrollHeight;
        }

        // Server Management
        function updateServerSuggestions() {
            const query = serverSearch && serverSearch.value ? serverSearch.value.toLowerCase().trim() : '';
            const mode = document.getElementById('modeFilter').value;
            document.getElementById('serverSuggestions').innerHTML = query ? servers
                .filter(s => s.name.toLowerCase().includes(query) && (mode === 'all' || s.mode === mode))
                .map(s => `<div class="suggestion" onclick="document.getElementById('serverSearch').value='${s.name}'; document.getElementById('serverSuggestions').innerHTML=''">${s.name} (${s.mode})</div>`)
                .join('') : '';
        }

        function createServer() {
            const serverName = document.getElementById('newServerName').value.trim();
            const mode = document.getElementById('newServerMode').value;
            if (serverName && !servers.some(s => s.name === serverName)) {
                servers.push({ name: serverName, mode, owner: username });
                localStorage.setItem('coneWorksServers', JSON.stringify(servers));
                joinServer(serverName);
            } else {
                alert(serverName ? 'Server name taken!' : 'Enter a server name!');
            }
        }

        function joinServer(serverName) {
            if (serverName === 'random') {
                const filteredServers = servers.filter(s => document.getElementById('modeFilter').value === 'all' || s.mode === document.getElementById('modeFilter').value);
                serverName = filteredServers[Math.floor(Math.random() * filteredServers.length)]?.name;
            }
            const server = servers.find(s => s.name === serverName);
            if (!server) {
                alert('Server Not Found!');
                return;
            }
            currentServer = serverName;
            serverOwner = server.owner;
            serverMode = server.mode;
            currentGame = 'game';
            firstPerson = defaultPOV === 'first';
            document.getElementById('serverPage').style.display = 'none';
            canvas.style.display = 'block';
            ui.style.display = 'block';
            publicChat.style.display = publicChatVisible ? 'block' : 'none';
            document.getElementById('fullscreenBtn').style.display = 'block';
            document.getElementById('backBtn').style.display = 'block';
            initGame();
            updatePublicChat();
            currencyTimer = Date.now();
        }

        function leaveServer() {
            currentServer = null;
            serverOwner = null;
            currentGame = null;
            serverMode = 'fight';
            players = {};
            canvas.style.display = 'none';
            ui.style.display = 'none';
            publicChat.style.display = 'none';
            voteBox.style.display = 'none';
            reportBox.style.display = 'none';
            shopBox.style.display = 'none';
            skinBox.style.display = 'none';
            document.getElementById('fullscreenBtn').style.display = 'none';
            document.getElementById('backBtn').style.display = 'none';
            showHome();
        }

        // Voting
        function startVote() {
            voteBox.style.display = 'block';
            voteOptions.innerHTML = `
                <button onclick="submitVote('Arena')">Arena</button>
                <button onclick="submitVote('Rooftop')">Rooftop</button>
                <button onclick="submitVote('Space Station')">Space Station</button>
            `;
        }

        function submitVote(mapName) {
            mapVotes[mapName]++;
            closeVote();
        }

        function closeVote() {
            voteBox.style.display = 'none';
            const maxVotes = Math.max(...Object.values(mapVotes));
            const winningMaps = Object.keys(mapVotes).filter(m => mapVotes[m] === maxVotes);
            map = winningMaps[Math.floor(Math.random() * winningMaps.length)];
            mapVotes = { Arena: 0, Rooftop: 0, 'Space Station': 0 };
            lastMapSwitch = Date.now();
            initGame();
        }

        // Reporting
        function openReportBox() {
            reportBox.style.display = 'block';
            reportPlayer.innerHTML = Object.keys(players)
                .filter(p => p !== username)
                .map(p => `<option value="${p}">${p}</option>`)
                .join('');
        }

        function submitReport() {
            const target = reportPlayer.value;
            if (target && players[target]) {
                if (username === 'Conehead8654' && username === serverOwner) {
                    delete players[target];
                    alert(`${target} has been banned from the server!`);
                } else {
                    alert(`Report submitted for ${target}.`);
                }
            }
            reportBox.style.display = 'none';
        }

        // Shop & Skins
        function openShop() {
            if (serverMode === 'fight') {
                shopBox.style.display = 'block';
                document.getElementById('weaponList').innerHTML = Object.entries(weapons)
                    .map(([name, { cost, damage }]) => `<div>${name} (+${damage} damage) - ${cost} Conecon <button onclick="buyWeapon('${name}', ${cost})">${accounts[username].equippedWeapon === name ? 'Equipped' : 'Buy'}</button></div>`)
                    .join('');
            }
        }

        function buyWeapon(name, cost) {
            if (conecon >= cost && accounts[username].equippedWeapon !== name) {
                conecon -= cost;
                accounts[username].equippedWeapon = name;
                accounts[username].conecon = conecon;
                localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                openShop();
                updateConeconDisplay();
            } else if (accounts[username].equippedWeapon !== name) {
                accounts[username].equippedWeapon = name;
                localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                openShop();
            } else {
                alert('Already equipped or not enough Conecon!');
            }
        }

        function openSkinShop() {
            skinBox.style.display = 'block';
            document.getElementById('skinList').innerHTML = Object.entries(skins)
                .map(([name, { cost, color }]) => `<div>${name} - ${cost} Conecon <button onclick="buySkin('${name}', ${cost})">${accounts[username].equippedSkin === name ? 'Equipped' : 'Buy'}</button></div>`)
                .join('');
        }

        function buySkin(name, cost) {
            if (conecon >= cost && accounts[username].equippedSkin !== name) {
                conecon -= cost;
                accounts[username].equippedSkin = name;
                accounts[username].conecon = conecon;
                localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                openSkinShop();
                updateConeconDisplay();
            } else if (accounts[username].equippedSkin !== name) {
                accounts[username].equippedSkin = name;
                localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                openSkinShop();
            } else {
                alert('Already equipped or not enough Conecon!');
            }
        }

        // Input
        let keys = {};
        window.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            if (currentGame === 'game' && e.key.toLowerCase() === 'c') {
                publicChatVisible = !publicChatVisible;
                publicChat.style.display = publicChatVisible ? 'block' : 'none';
            }
            if (currentGame === 'game' && e.key.toLowerCase() === 'o') {
                firstPerson = !firstPerson;
            }
            if (currentGame === 'game' && e.key.toLowerCase() === 'r') {
                openReportBox();
            }
            if (currentGame === 'game' && e.key.toLowerCase() === 'p') {
                openShop();
            }
            if (currentGame === 'game' && e.key.toLowerCase() === 'k') {
                openSkinShop();
            }
        });
        window.addEventListener('keyup', (e) => { keys[e.key.toLowerCase()] = false; });
        canvas.addEventListener('click', () => {
            if (currentGame === 'game') canvas.requestPointerLock();
        });
        canvas.addEventListener('mousemove', (e) => {
            if (currentGame === 'game' && document.pointerLockElement === canvas) {
                yaw -= e.movementX * mouseSensitivity;
                pitch -= e.movementY * mouseSensitivity;
                pitch = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, pitch));
            }
        });

        // Game
        function initGame() {
            if (!gl) return;
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            gl.viewport(0, 0, canvas.width, canvas.height);
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                if (gl) gl.viewport(0, 0, canvas.width, canvas.height);
            });

            const vsSource = `
                attribute vec4 aPosition; attribute vec3 aNormal; attribute vec4 aColor;
                uniform mat4 uModelViewMatrix; uniform mat4 uProjectionMatrix;
                varying vec3 vNormal; varying vec4 vColor;
                void main() { gl_Position = uProjectionMatrix * uModelViewMatrix * aPosition; vNormal = aNormal; vColor = aColor; }
            `;
            const fsSource = `
                precision mediump float; varying vec3 vNormal; varying vec4 vColor;
                void main() {
                    float light = max(0.0, dot(vNormal, vec3(0.0, 1.0, 0.0))) * 0.8 + 0.2;
                    gl_FragColor = vColor * light;
                }
            `;

            function loadShader(type, source) {
                const shader = gl.createShader(type);
                gl.shaderSource(shader, source);
                gl.compileShader(shader);
                if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                    console.error('Shader compile error:', gl.getShaderInfoLog(shader));
                    gl.deleteShader(shader);
                    return null;
                }
                return shader;
            }
            const shaderProgram = gl.createProgram();
            gl.attachShader(shaderProgram, loadShader(gl.VERTEX_SHADER, vsSource));
            gl.attachShader(shaderProgram, loadShader(gl.FRAGMENT_SHADER, fsSource));
            gl.linkProgram(shaderProgram);
            if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
                console.error('Program link error:', gl.getProgramInfoLog(shaderProgram));
                return;
            }
            gl.useProgram(shaderProgram);

            const positionLocation = gl.getAttribLocation(shaderProgram, 'aPosition');
            const normalLocation = gl.getAttribLocation(shaderProgram, 'aNormal');
            const colorLocation = gl.getAttribLocation(shaderProgram, 'aColor');
            const modelViewMatrixLoc = gl.getUniformLocation(shaderProgram, 'uModelViewMatrix');
            const projectionMatrixLoc = gl.getUniformLocation(shaderProgram, 'uProjectionMatrix');

            // Baseplate
            const baseplatePositions = new Float32Array([
                -20, 0, -20, 20, 0, -20, 20, 0, 20,
                -20, 0, -20, 20, 0, 20, -20, 0, 20
            ]);
            const baseplateNormals = new Float32Array(Array(baseplatePositions.length / 3).fill(0).flatMap(() => [0, 1, 0]));
            const baseplateColors = new Float32Array(Array(baseplatePositions.length / 3).fill(0).flatMap(() => [0.3, 0.5, 0.3, 1]));
            const baseplateBuffer = gl.createBuffer();
            const baseplateNormalBuffer = gl.createBuffer();
            const baseplateColorBuffer = gl.createBuffer();

            // Player Models
            function getPlayerModel(skin) {
                const head = [
                    -0.3, 1.2, -0.3, 0.3, 1.2, -0.3, 0.3, 1.5, -0.3,
                    -0.3, 1.2, -0.3, 0.3, 1.5, -0.3, -0.3, 1.5, -0.3
                ];
                const body = [
                    -0.4, 0.5, -0.4, 0.4, 0.5, -0.4, 0.4, 1.0, -0.4,
                    -0.4, 0.5, -0.4, 0.4, 1.0, -0.4, -0.4, 1.0, -0.4
                ];
                const leftArm = [
                    -0.6, 0.5, -0.1, -0.4, 0.5, -0.1, -0.4, 1.0, -0.1,
                    -0.6, 0.5, -0.1, -0.4, 1.0, -0.1, -0.6, 1.0, -0.1
                ];
                const rightArm = [
                    0.4, 0.5, -0.1, 0.6, 0.5, -0.1, 0.6, 1.0, -0.1,
                    0.4, 0.5, -0.1, 0.6, 1.0, -0.1, 0.4, 1.0, -0.1
                ];
                const leftLeg = [
                    -0.2, 0, -0.6, -0.2, 0.5, -0.6, 0.2, 0.5, -0.6,
                    -0.2, 0, -0.6, 0.2, 0.5, -0.6, 0.2, 0, -0.6
                ];
                const rightLeg = [
                    -0.2, 0, 0.6, -0.2, 0.5, 0.6, 0.2, 0.5, 0.6,
                    -0.2, 0, 0.6, 0.2, 0.5, 0.6, 0.2, 0, 0.6
                ];
                return new Float32Array([...head, ...body, ...leftArm, ...rightArm, ...leftLeg, ...rightLeg]);
            }

            players[username] = {
                x: 0, y: 2, z: 0, vx: 0, vy: 0, vz: 0,
                health: serverMode === 'fight' ? 100 : null,
                wins: accounts[username].wins || 0,
                color: skins[equippedSkin].color,
                username: username,
                skin: equippedSkin,
                weapon: equippedWeapon
            };

            function gameUpdate() {
                updateCurrency();
                const player = players[username];
                const speed = 0.1;
                const gravity = 0.05;
                const forward = [Math.sin(yaw), 0, Math.cos(yaw)];
                const right = [Math.cos(yaw), 0, -Math.sin(yaw)];
                player.vx = 0;
                player.vz = 0;
                if (keys['w'] || keys['arrowup']) { player.vx += forward[0] * speed; player.vz += forward[2] * speed; }
                if (keys['s'] || keys['arrowdown']) { player.vx -= forward[0] * speed; player.vz -= forward[2] * speed; }
                if (keys['a'] || keys['arrowleft']) { player.vx -= right[0] * speed; player.vz -= right[2] * speed; }
                if (keys['d'] || keys['arrowright']) { player.vx += right[0] * speed; player.vz += right[2] * speed; }
                if (keys[' '] && player.y <= 2) { player.vy = 0.3; }
                player.vx *= 0.8;
                player.vy -= gravity;
                player.vz *= 0.8;
                player.x += player.vx;
                player.y += player.vy;
                player.z += player.vz;
                if (player.y < 2) { player.y = 2; player.vy = 0; }

                // Collisions
                for (let p in players) {
                    if (p !== username) {
                        const other = players[p];
                        const dx = player.x - other.x;
                        const dz = player.z - other.z;
                        const dist = Math.sqrt(dx * dx + dz * dz);
                        if (dist < 1 && dist > 0) {
                            player.x += (dx / dist) * 0.1;
                            player.z += (dz / dist) * 0.1;
                            other.x -= (dx / dist) * 0.1;
                            other.z -= (dz / dist) * 0.1;
                        }
                    }
                }

                // Attack
                if (serverMode === 'fight' && keys['e'] && !keys['space']) {
                    for (let p in players) {
                        if (p !== username) {
                            const dx = player.x - players[p].x;
                            const dz = player.z - players[p].z;
                            const dist = Math.sqrt(dx * dx + dz * dz);
                            if (dist < 2) {
                                players[p].health -= weapons[equippedWeapon].damage;
                                if (players[p].health <= 0) {
                                    players[p].x = Math.random() * 10 - 5;
                                    players[p].z = Math.random() * 10 - 5;
                                    players[p].health = 100;
                                    player.wins++;
                                    accounts[username].wins = player.wins;
                                    localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                                }
                            }
                        }
                    }
                }

                if (Date.now() - lastMapSwitch > mapTimer) startVote();
                requestAnimationFrame(gameUpdate);
            }

            function gameRender() {
                if (!gl) return;
                gl.clearColor(map === 'Arena' ? 0.5 : map === 'Rooftop' ? 0.7 : 0.2, map === 'Rooftop' ? 0.8 : 0.5, map === 'Space Station' ? 0.2 : 1.0, 1.0);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                gl.enable(gl.DEPTH_TEST);

                const fov = Math.PI / 3;
                const aspect = canvas.width / canvas.height;
                const zNear = 0.1, zFar = 100;
                const proj = new Float32Array([
                    1 / (aspect * Math.tan(fov / 2)), 0, 0, 0,
                    0, 1 / Math.tan(fov / 2), 0, 0,
                    0, 0, -(zFar + zNear) / (zFar - zNear), -1,
                    0, 0, -2 * zFar * zNear / (zFar - zNear), 0
                ]);

                const player = players[username];
                const cameraOffset = firstPerson ? [0, 1.4, 0] : [0, 2, -5];
                const cosP = Math.cos(pitch), sinP = Math.sin(pitch);
                const cosY = Math.cos(yaw), sinY = Math.sin(yaw);
                const modelView = new Float32Array([
                    cosY, sinY * sinP, -sinY * cosP, 0,
                    0, cosP, sinP, 0,
                    sinY, -cosY * sinP, cosY * cosP, 0,
                    -(player.x + cameraOffset[0] * cosY + cameraOffset[2] * sinY * cosP),
                    -(player.y + cameraOffset[1] + cameraOffset[2] * sinP),
                    -(player.z + cameraOffset[0] * sinY - cameraOffset[2] * cosY * cosP), 1
                ]);

                gl.uniformMatrix4fv(projectionMatrixLoc, false, proj);
                gl.uniformMatrix4fv(modelViewMatrixLoc, false, modelView);

                // Render Baseplate
                gl.bindBuffer(gl.ARRAY_BUFFER, baseplateBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, baseplatePositions, gl.STATIC_DRAW);
                gl.vertexAttribPointer(positionLocation, 3, gl.FLOAT, false, 0, 0);
                gl.enableVertexAttribArray(positionLocation);
                gl.bindBuffer(gl.ARRAY_BUFFER, baseplateNormalBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, baseplateNormals, gl.STATIC_DRAW);
                gl.vertexAttribPointer(normalLocation, 3, gl.FLOAT, false, 0, 0);
                gl.enableVertexAttribArray(normalLocation);
                gl.bindBuffer(gl.ARRAY_BUFFER, baseplateColorBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, baseplateColors, gl.STATIC_DRAW);
                gl.vertexAttribPointer(colorLocation, 4, gl.FLOAT, false, 0, 0);
                gl.enableVertexAttribArray(colorLocation);
                gl.drawArrays(gl.TRIANGLES, 0, baseplatePositions.length / 3);

                // Render Players
                for (let p in players) {
                    const player = players[p];
                    const positions = getPlayerModel(player.skin);
                    const normals = new Float32Array(Array(positions.length / 3).fill(0).flatMap(() => [0, 0, 1]));
                    const colors = new Float32Array(Array(positions.length / 3).fill(0).flatMap(() => player.color));
                    const positionBuffer = gl.createBuffer();
                    gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
                    gl.bufferData(gl.ARRAY_BUFFER, positions, gl.STATIC_DRAW);
                    gl.vertexAttribPointer(positionLocation, 3, gl.FLOAT, false, 0, 0);
                    gl.enableVertexAttribArray(positionLocation);
                    gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer());
                    gl.bufferData(gl.ARRAY_BUFFER, normals, gl.STATIC_DRAW);
                    gl.vertexAttribPointer(normalLocation, 3, gl.FLOAT, false, 0, 0);
                    gl.enableVertexAttribArray(normalLocation);
                    gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer());
                    gl.bufferData(gl.ARRAY_BUFFER, colors, gl.STATIC_DRAW);
                    gl.vertexAttribPointer(colorLocation, 4, gl.FLOAT, false, 0, 0);
                    gl.enableVertexAttribArray(colorLocation);
                    const playerMatrix = new Float32Array([
                        1, 0, 0, 0,
                        0, 1, 0, 0,
                        0, 0, 1, 0,
                        player.x, player.y, player.z, 1
                    ]);
                    gl.uniformMatrix4fv(modelViewMatrixLoc, false, playerMatrix);
                    gl.drawArrays(gl.TRIANGLES, 0, positions.length / 3);

                    // Username Billboard
                    ctx.save();
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    const screenPos = toScreenPosition(player.x, player.y + 2, player.z, proj, modelView);
                    ctx.fillStyle = 'white';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(player.username, screenPos.x, screenPos.y);
                    ctx.restore();
                }

                // UI for Currency (in-game)
                ctx.fillStyle = 'yellow';
                ctx.font = '20px Arial';
                ctx.textAlign = currencyDisplay === 'top-left' ? 'left' : 'right';
                ctx.fillText(`Conecon: ${conecon}`, currencyDisplay === 'top-left' ? 10 : canvas.width - 10, 30);

                requestAnimationFrame(gameRender);
            }

            function toScreenPosition(x, y, z, proj, mv) {
                const vec = [x, y, z, 1];
                const mvVec = [0, 0, 0, 0];
                for (let i = 0; i < 4; i++) {
                    for (let j = 0; j < 4; j++) {
                        mvVec[i] += mv[i * 4 + j] * vec[j];
                    }
                }
                const projVec = [0, 0, 0, 0];
                for (let i = 0; i < 4; i++) {
                    for (let j = 0; j < 4; j++) {
                        projVec[i] += proj[i * 4 + j] * mvVec[j];
                    }
                }
                return {
                    x: (projVec[0] / projVec[3] + 1) * canvas.width / 2,
                    y: (1 - projVec[1] / projVec[3]) * canvas.height / 2
                };
            }

            gameUpdate();
            gameRender();
        }

        // Init
        document.getElementById('defaultPOV').value = defaultPOV;
        document.getElementById('mouseSensitivity').value = mouseSensitivity;
        document.getElementById('currencyDisplay').value = currencyDisplay;
        updateFriends();
        updateChat();
        updateConeconDisplay();
        if (!accounts['Conehead8654']) {
            accounts['Conehead8654'] = { password: 'Di@d09202015', friends: [], requestsSent: [], wins: 0, conecon: 0, equippedSkin: 'default-boy', equippedWeapon: 'fist' };
            localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
        }
    </script>
</body>
</html>
