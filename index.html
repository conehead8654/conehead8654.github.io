<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConeWorks</title>
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }
        h1 {
            font-size: 3.5em;
            text-shadow: 0 0 10px #00ffcc;
            margin-bottom: 10px;
        }
        p {
            font-size: 1.2em;
            max-width: 600px;
            text-align: center;
            margin-bottom: 20px;
        }
        #versionDisplay {
            font-size: 1em;
            color: #00ffcc;
            margin-bottom: 20px;
        }
        .login-container, .game-buttons, .settings-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        .game-buttons { flex-direction: row; flex-wrap: wrap; }
        input, button, select {
            padding: 10px;
            font-size: 1.1em;
            border: none;
            border-radius: 5px;
        }
        input, select {
            width: 200px;
            background: #fff;
            color: #333;
        }
        button {
            background: linear-gradient(to right, #ff6b6b, #ff8e53);
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        canvas {
            display: none;
            border: 3px solid #00ffcc;
            border-radius: 10px;
            background: #000;
        }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 5px;
        }
        #publicChat {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 300px;
            height: 150px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            font-size: 14px;
            overflow-y: auto;
            display: none;
        }
        #publicChatInput {
            width: 280px;
            margin-top: 5px;
        }
        #chatBox {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            display: none;
            font-size: 14px;
            overflow-y: auto;
        }
        #chatInput {
            width: 380px;
            margin-top: 5px;
        }
        #friendBox {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 250px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            display: none;
            font-size: 14px;
        }
        #playerListBox {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            display: none;
            font-size: 14px;
            overflow-y: auto;
            max-height: 400px;
        }
        #friendSearch, #serverSearch, #newServerName, #deleteUsername, #deletePassword {
            width: 220px;
            margin-bottom: 5px;
        }
        #friendSuggestions, #serverSuggestions {
            max-height: 100px;
            overflow-y: auto;
            background: #333;
            border-radius: 5px;
        }
        .suggestion {
            padding: 5px;
            cursor: pointer;
        }
        .suggestion:hover {
            background: #555;
        }
        #notification {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: #00ffcc;
            color: #000;
            padding: 10px;
            border-radius: 5px;
            display: none;
            max-width: 300px;
        }
        #voteBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        #reportBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        #shopBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        #skinBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        #deleteAccountBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        .back-btn {
            position: absolute;
            top: 50px;
            right: 10px;
            padding: 10px 20px;
            background: #f44336;
            color: white;
        }
        .back-btn:hover {
            background: #da190b;
        }
        #fullscreenBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10;
        }
        #coneconDisplay {
            position: absolute;
            top: 10px;
            font-size: 20px;
            color: yellow;
        }
        #controlsBox {
            display: none;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            text-align: left;
            max-width: 300px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 5px;
            text-align: left;
            border-bottom: 1px solid #555;
        }
    </style>
</head>
<body>
    <div id="loginPage">
        <h1>ConeWorks</h1>
        <div id="versionDisplay"></div>
        <p>Sign in or create an account to brawl and chill!</p>
        <div class="login-container">
            <input id="username" type="text" placeholder="Username">
            <input id="password" type="password" placeholder="Password">
            <button onclick="login()">Login</button>
            <button onclick="signup()">Sign Up</button>
            <button onclick="toggleControls()">Show Controls</button>
            <div id="controlsBox">
                <h3>Controls</h3>
                <ul>
                    <li><b>WASD</b>: Move (camera-relative)</li>
                    <li><b>Space</b>: Jump</li>
                    <li><b>E</b>: Attack (Fight mode)</li>
                    <li><b>O</b>: Toggle POV (first/third-person)</li>
                    <li><b>C</b>: Toggle server chat</li>
                    <li><b>R</b>: Report/ban player (Conehead8654 only)</li>
                    <li><b>P</b>: Open weapon shop</li>
                    <li><b>K</b>: Open skin shop</li>
                    <li><b>L</b>: Toggle player list</li>
                </ul>
            </div>
        </div>
    </div>
    <div id="homePage" style="display: none;">
        <div id="coneconDisplay"></div>
        <h1>ConeWorks</h1>
        <div id="versionDisplay"></div>
        <p>Create or join epic servers to brawl or chill.</p>
        <div class="game-buttons">
            <button onclick="loadServerPage()">Join Server</button>
            <button onclick="loadCreateServerPage()">Create Server</button>
            <button onclick="toggleChatBox()">Chat & Friends</button>
            <button onclick="toggleFriendBox()">Search Players</button>
            <button onclick="togglePlayerList()">Player List</button>
            <button onclick="testMultiplayer()">Test Multiplayer</button>
            <button onclick="loadSettingsPage()">Settings</button>
        </div>
        <p>Earn 1 Conecon per minute in-game to buy skins and weapons!</p>
    </div>
    <div id="serverPage" style="display: none;">
        <h1>Join a Server</h1>
        <p>Search for a server or join a random one!</p>
        <input id="serverSearch" type="text" placeholder="Search servers..." oninput="updateServerSuggestions(); updateServerList()">
        <label for="modeFilter">Filter Mode:</label>
        <select id="modeFilter" aria-label="Filter servers by game mode" onchange="updateServerSuggestions(); updateServerList()">
            <option value="all">All Modes</option>
            <option value="fight">Fight</option>
            <option value="chill">Chill</option>
        </select>
        <div id="serverSuggestions"></div>
        <div id="serverList">
            <table>
                <thead>
                    <tr><th>Name</th><th>Mode</th><th>Players</th><th>Action</th></tr>
                </thead>
                <tbody id="serverTableBody"></tbody>
            </table>
        </div>
        <div class="game-buttons">
            <button onclick="joinServer('random')">Join Random</button>
            <button onclick="joinServer(document.getElementById('serverSearch').value)">Join Server</button>
            <button onclick="showHome()">Back</button>
        </div>
    </div>
    <div id="createServerPage" style="display: none;">
        <h1>Create a Server</h1>
        <p>Choose a name and mode for your server!</p>
        <input id="newServerName" type="text" placeholder="Server Name">
        <label for="newServerMode">Server Mode:</label>
        <select id="newServerMode" aria-label="Select server game mode">
            <option value="fight">Fight</option>
            <option value="chill">Chill</option>
        </select>
        <div class="game-buttons">
            <button onclick="createServer()">Create</button>
            <button onclick="showHome()">Back</button>
        </div>
    </div>
    <div id="settingsPage" style="display: none;">
        <h1>Settings</h1>
        <p>Customize your ConeWorks experience.</p>
        <div class="settings-container">
            <label for="defaultPOV">Default POV on Join:</label>
            <select id="defaultPOV" aria-label="Select default camera perspective">
                <option value="third">Third-Person</option>
                <option value="first">First-Person</option>
            </select>
            <label for="mouseSensitivity">Mouse Sensitivity:</label>
            <input type="range" id="mouseSensitivity" min="0.001" max="0.01" step="0.001" value="0.002">
            <label for="currencyDisplay">Currency Display:</label>
            <select id="currencyDisplay" aria-label="Select currency display position">
                <option value="top-left">Top-Left</option>
                <option value="top-right">Top-Right</option>
            </select>
            <button onclick="saveSettings()">Save</button>
            <button onclick="backupData()">Backup Data</button>
            <button onclick="restoreData()">Restore Data</button>
            <button onclick="showDeleteAccount()">Delete Account</button>
            <button onclick="showHome()">Back</button>
        </div>
    </div>
    <div id="deleteAccountBox" style="display: none;">
        <h2>Delete Account</h2>
        <p>Enter your username and password to confirm deletion.</p>
        <input id="deleteUsername" type="text" placeholder="Username">
        <input id="deletePassword" type="password" placeholder="Password">
        <div class="game-buttons">
            <button onclick="deleteAccount()">Confirm Delete</button>
            <button onclick="document.getElementById('deleteAccountBox').style.display='none'">Cancel</button>
        </div>
    </div>
    <div id="playerListBox" style="display: none;">
        <h2>Player Leaderboard</h2>
        <table>
            <thead>
                <tr><th>Username</th><th>Wins</th><th>Conecons</th><th>Action</th></tr>
            </thead>
            <tbody id="playerList"></tbody>
        </table>
        <button onclick="togglePlayerList()">Close</button>
    </div>
    <canvas id="canvas" width="800" height="600"></canvas>
    <button id="fullscreenBtn" onclick="toggleFullscreen()" style="display: none;">Fullscreen</button>
    <button id="backBtn" class="back-btn" onclick="leaveServer()" style="display: none;">Leave Server</button>
    <div id="ui" style="display: none;"></div>
    <div id="publicChat" style="display: none;">
        <div id="publicChatMessages"></div>
        <input id="publicChatInput" type="text" placeholder="Server chat..." onkeydown="if(event.key === 'Enter') sendPublicMessage()">
    </div>
    <div id="chatBox" style="display: none;">
        <div id="chatMessages"></div>
        <input id="chatInput" type="text" placeholder="Message friends..." onkeydown="if(event.key === 'Enter') sendMessage()">
        <button onclick="toggleChatBox()">Close</button>
    </div>
    <div id="friendBox" style="display: none;">
        <div>Friends</div>
        <input id="friendSearch" type="text" placeholder="Search players..." oninput="updateFriendSuggestions()">
        <div id="friendSuggestions"></div>
        <div id="friendList"></div>
        <div id="friendRequests"></div>
        <button onclick="sendFriendRequest()">Send Friend Request</button>
        <button onclick="toggleFriendBox()">Close</button>
    </div>
    <div id="notification"></div>
    <div id="voteBox" style="display: none;">
        <h2>Vote for Next Map</h2>
        <div id="voteOptions"></div>
        <button onclick="closeVote()">Close</button>
    </div>
    <div id="reportBox" style="display: none;">
        <h2>Report Player</h2>
        <label for="reportPlayer">Select Player:</label>
        <select id="reportPlayer" aria-label="Select player to report"></select>
        <button onclick="submitReport()">Report</button>
        <button onclick="document.getElementById('reportBox').style.display='none'">Cancel</button>
    </div>
    <div id="shopBox" style="display: none;">
        <h2>Weapons Shop</h2>
        <div id="weaponList"></div>
        <button onclick="document.getElementById('shopBox').style.display='none'">Close</button>
    </div>
    <div id="skinBox" style="display: none;">
        <h2>Skins Shop</h2>
        <div id="skinList"></div>
        <button onclick="document.getElementById('skinBox').style.display='none'">Close</button>
    </div>
    <input id="restoreInput" type="file" accept=".json" style="display: none;" onchange="handleRestore(event)" title="Restore backup file">
    <label for="restoreInput" style="display: none;">Restore Backup</label>

    <script>
        // State
        let version = localStorage.getItem('coneWorksVersion') ? parseFloat(localStorage.getItem('coneWorksVersion')) : 1.9;
        localStorage.setItem('coneWorksVersion', version);
        document.querySelectorAll('#versionDisplay').forEach(el => el.textContent = `Version ${version.toFixed(1)}`);
        localStorage.removeItem('coneWorksServers');
        let currentGame = null;
        let currentServer = null;
        let serverOwner = null;
        let username = null;
        let accounts = JSON.parse(localStorage.getItem('coneWorksAccounts')) || {};
        let friends = [];
        let friendRequestsSent = [];
        let friendRequestsReceived = [];
        let messages = JSON.parse(localStorage.getItem('coneWorksMessages')) || [];
        let publicMessages = [];
        let servers = [];
        let players = {};
        let map = 'Arena';
        let mapVotes = { Arena: 0, Rooftop: 0, 'Space Station': 0 };
        let mapTimer = 30 * 60 * 1000;
        let lastMapSwitch = Date.now();
        let firstPerson = false;
        let defaultPOV = localStorage.getItem('coneWorksDefaultPOV') || 'third';
        let mouseSensitivity = parseFloat(localStorage.getItem('coneWorksMouseSensitivity')) || 0.002;
        let currencyDisplay = localStorage.getItem('coneWorksCurrencyDisplay') || 'top-left';
        let yaw = 0, pitch = 0;
        let serverMode = 'fight';
        let conecon = parseInt(localStorage.getItem('coneWorksConecon')) || 0;
        let equippedSkin = 'default-boy';
        let equippedWeapon = 'fist';
        let skins = {
            'default-boy': { cost: 0, color: [1, 0, 0, 1] },
            'default-girl': { cost: 0, color: [1, 0.5, 0.5, 1] },
            'ninja-boy': { cost: 50, color: [0.2, 0.2, 0.2, 1] },
            'princess-girl': { cost: 75, color: [1, 0.8, 0.8, 1] },
            'robot-boy': { cost: 100, color: [0.5, 0.5, 0.5, 1] },
            'warrior-girl': { cost: 150, color: [0.7, 0.2, 0.2, 1] }
        };
        let weapons = {
            'fist': { cost: 0, damage: 10 },
            'sword': { cost: 20, damage: 20 },
            'gun': { cost: 50, damage: 30 },
            'laser': { cost: 100, damage: 40 }
        };
        let currencyTimer = Date.now();
        let use2D = false;
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        if (!gl) {
            console.warn('WebGL not supported, switching to 2D canvas');
            use2D = true;
        }
        const ui = document.getElementById('ui');
        const publicChat = document.getElementById('publicChat');
        const publicChatMessages = document.getElementById('publicChatMessages');
        const publicChatInput = document.getElementById('publicChatInput');
        const chatBox = document.getElementById('chatBox');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const friendBox = document.getElementById('friendBox');
        const friendSearch = document.getElementById('friendSearch');
        const friendSuggestions = document.getElementById('friendSuggestions');
        const friendList = document.getElementById('friendList');
        const friendRequests = document.getElementById('friendRequests');
        const playerListBox = document.getElementById('playerListBox');
        const playerList = document.getElementById('playerList');
        const serverList = document.getElementById('serverList');
        const serverTableBody = document.getElementById('serverTableBody');
        const notification = document.getElementById('notification');
        const voteBox = document.getElementById('voteBox');
        const voteOptions = document.getElementById('voteOptions');
        const reportBox = document.getElementById('reportBox');
        const reportPlayer = document.getElementById('reportPlayer');
        const shopBox = document.getElementById('shopBox');
        const skinBox = document.getElementById('skinBox');
        const deleteAccountBox = document.getElementById('deleteAccountBox');
        const coneconDisplay = document.getElementById('coneconDisplay');
        let publicChatVisible = true;

        // Login & Signup
        function login() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value;
            if (accounts[user] && accounts[user].password === pass) {
                username = user;
                friends = accounts[user].friends || [];
                friendRequestsSent = accounts[user].requestsSent || [];
                friendRequestsReceived = JSON.parse(localStorage.getItem('coneWorksRequestsReceived'))?.[user] || [];
                conecon = accounts[user].conecon || 0;
                equippedSkin = accounts[user].equippedSkin || 'default-boy';
                equippedWeapon = accounts[user].equippedWeapon || 'fist';
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('homePage').style.display = 'block';
                updateFriends();
                updateChat();
                updateConeconDisplay();
                updatePlayerList();
            } else {
                alert('Invalid username or password!');
            }
        }

        function signup() {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value;
            if (user && pass && !accounts[user] && user !== 'Conehead8654') {
                accounts[user] = { password: pass, friends: [], requestsSent: [], wins: 0, conecon: 0, equippedSkin: 'default-boy', equippedWeapon: 'fist' };
                localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                username = user;
                friends = [];
                friendRequestsSent = [];
                friendRequestsReceived = [];
                conecon = 0;
                equippedSkin = 'default-boy';
                equippedWeapon = 'fist';
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('homePage').style.display = 'block';
                updateFriends();
                updateChat();
                updateConeconDisplay();
                updatePlayerList();
            } else if (user === 'Conehead8654') {
                alert('Username "Conehead8654" is reserved!');
            } else {
                alert(accounts[user] ? 'Username taken!' : 'Enter a valid username and password!');
            }
        }

        // Account Deletion
        function showDeleteAccount() {
            document.getElementById('deleteAccountBox').style.display = 'block';
            document.getElementById('deleteUsername').value = '';
            document.getElementById('deletePassword').value = '';
        }

        function deleteAccount() {
            const user = document.getElementById('deleteUsername').value.trim();
            const pass = document.getElementById('deletePassword').value;
            if (user === username && accounts[user] && accounts[user].password === pass) {
                delete accounts[user];
                let received = JSON.parse(localStorage.getItem('coneWorksRequestsReceived')) || {};
                delete received[user];
                friends.forEach(f => {
                    accounts[f].friends = accounts[f].friends.filter(fr => fr !== user);
                    accounts[f].requestsSent = accounts[f].requestsSent.filter(r => r !== user);
                });
                localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                localStorage.setItem('coneWorksRequestsReceived', JSON.stringify(received));
                messages = messages.filter(m => m.from !== user);
                localStorage.setItem('coneWorksMessages', JSON.stringify(messages));
                username = null;
                friends = [];
                friendRequestsSent = [];
                friendRequestsReceived = [];
                conecon = 0;
                document.getElementById('deleteAccountBox').style.display = 'none';
                document.getElementById('settingsPage').style.display = 'none';
                document.getElementById('loginPage').style.display = 'block';
                alert('Account deleted successfully!');
            } else {
                alert('Invalid username or password!');
            }
        }

        // Backup & Restore
        function backupData() {
            const data = {
                accounts: localStorage.getItem('coneWorksAccounts'),
                messages: localStorage.getItem('coneWorksMessages'),
                requests: localStorage.getItem('coneWorksRequestsReceived'),
                servers: localStorage.getItem('coneWorksServers'),
                settings: {
                    pov: localStorage.getItem('coneWorksDefaultPOV'),
                    sensitivity: localStorage.getItem('coneWorksMouseSensitivity'),
                    currency: localStorage.getItem('coneWorksCurrencyDisplay')
                }
            };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'coneWorksBackup.json';
            a.click();
            URL.revokeObjectURL(url);
            alert('Data backed up successfully!');
        }

        function restoreData() {
            document.getElementById('restoreInput').click();
        }

        function handleRestore(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.accounts) localStorage.setItem('coneWorksAccounts', data.accounts);
                        if (data.messages) localStorage.setItem('coneWorksMessages', data.messages);
                        if (data.requests) localStorage.setItem('coneWorksRequestsReceived', data.requests);
                        if (data.servers) localStorage.setItem('coneWorksServers', data.servers);
                        if (data.settings) {
                            if (data.settings.pov) localStorage.setItem('coneWorksDefaultPOV', data.settings.pov);
                            if (data.settings.sensitivity) localStorage.setItem('coneWorksMouseSensitivity', data.settings.sensitivity);
                            if (data.settings.currency) localStorage.setItem('coneWorksCurrencyDisplay', data.settings.currency);
                        }
                        accounts = JSON.parse(localStorage.getItem('coneWorksAccounts')) || {};
                        messages = JSON.parse(localStorage.getItem('coneWorksMessages')) || [];
                        servers = JSON.parse(localStorage.getItem('coneWorksServers')) || servers;
                        defaultPOV = localStorage.getItem('coneWorksDefaultPOV') || 'third';
                        mouseSensitivity = parseFloat(localStorage.getItem('coneWorksMouse
