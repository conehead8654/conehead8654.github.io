<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Permissions-Policy" content="fullscreen=(self)">
    <title>ConeWorks</title>
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: visible !important;
            position: static !important;
        }
        h1 {
            font-size: 3.5em;
            text-shadow: 0 0 10px #00ffcc;
            margin-bottom: 10px;
        }
        p {
            font-size: 1.2em;
            max-width: 600px;
            text-align: center;
            margin-bottom: 20px;
        }
        #versionDisplay {
            font-size: 1em;
            color: #00ffcc;
            margin-bottom: 20px;
        }
        .login-container, .game-buttons, .settings-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        .game-buttons { flex-direction: row; flex-wrap: wrap; }
        input, button, select {
            padding: 10px;
            font-size: 1.1em;
            border: none;
            border-radius: 5px;
        }
        input, select {
            width: 200px;
            background: #fff;
            color: #333;
        }
        button {
            background: linear-gradient(to right, #ff6b6b, #ff8e53);
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 5000 !important;
        }
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        button#resetDataBtn, button#clearCacheBtn {
            background: #f44336;
        }
        canvas {
            display: none;
            border: 3px solid #00ffcc;
            border-radius: 10px;
            background: #000;
            z-index: 1000 !important;
        }
        #ui {
            position: fixed !important;
            top: 10px !important;
            left: 10px !important;
            z-index: 10000 !important;
            font-size: 24px !important;
            background: rgba(0, 0, 0, 0.9) !important;
            padding: 20px !important;
            border-radius: 5px !important;
            border: 2px solid #00ffcc !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            overflow: visible !important;
            touch-action: auto !important;
            min-width: 200px !important;
            pointer-events: auto !important;
        }
        #ui button {
            margin: 10px !important;
            padding: 20px !important;
            font-size: 24px !important;
            width: 180px !important;
            text-align: center !important;
            border-radius: 5px !important;
            border: 2px solid white !important;
            background: #ff0000 !important;
            color: white !important;
            opacity: 1 !important;
            z-index: 10001 !important;
            pointer-events: auto !important;
        }
        #testButton, #testButton2 {
            background: #ff0000 !important;
            color: white !important;
            border: 2px solid white !important;
            z-index: 10001 !important;
        }
        #publicChat {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 300px;
            height: 150px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            font-size: 14px;
            overflow-y: auto;
            display: none;
            z-index: 2000 !important;
        }
        #publicChatInput {
            width: 280px;
            margin-top: 5px;
        }
        #chatBox {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            display: none;
            font-size: 14px;
            overflow-y: auto;
            z-index: 2000 !important;
        }
        #chatInput {
            width: 380px;
            margin-top: 5px;
        }
        #friendBox {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 250px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            display: none;
            font-size: 14px;
            z-index: 2000 !important;
        }
        #playerListBox {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            display: none;
            font-size: 14px;
            overflow-y: auto;
            max-height: 400px;
            z-index: 2000 !important;
        }
        #friendSearch, #serverSearch, #newServerName, #deleteUsername, #deletePassword {
            width: 220px;
            margin-bottom: 5px;
        }
        #friendSuggestions, #serverSuggestions {
            max-height: 100px;
            overflow-y: auto;
            background: #333;
            border-radius: 5px;
        }
        .suggestion {
            padding: 5px;
            cursor: pointer;
        }
        .suggestion:hover {
            background: #555;
        }
        #notification {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: #00ffcc;
            color: #000;
            padding: 10px;
            border-radius: 5px;
            display: none;
            max-width: 300px;
            z-index: 2000 !important;
        }
        #voteBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
            z-index: 2000 !important;
        }
        #reportBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
            z-index: 2000 !important;
        }
        #reviewReportsBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
            max-height: 500px;
            overflow-y: auto;
            width: 400px;
            z-index: 2000 !important;
        }
        #shopBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
            z-index: 2000 !important;
        }
        #skinBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
            z-index: 2000 !important;
        }
        #deleteAccountBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
            z-index: 2000 !important;
        }
        .back-btn {
            position: absolute;
            top: 50px;
            right: 10px;
            padding: 10px 20px;
            background: #f44336;
            color: white;
            z-index: 2000 !important;
        }
        .back-btn:hover {
            background: #da190b;
        }
        #fullscreenBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 5000 !important;
        }
        #coneconDisplay {
            position: absolute;
            top: 10px;
            font-size: 20px;
            color: yellow;
            z-index: 5000 !important;
        }
        #controlsBox {
            display: none;
            background: rgba(0, 0, 0, 0.95) !important;
            border: 2px solid #ffffff !important;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            text-align: left;
            max-width: 300px;
            z-index: 2000 !important;
            color: #ffffff !important;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 5px;
            text-align: left;
            border-bottom: 1px solid #555;
        }
    </style>
</head>
<body>
    <button id="fullscreenBtn" onclick="toggleFullscreen()">Fullscreen</button>
    <div id="loginPage">
        <h1>ConeWorks</h1>
        <div id="versionDisplay">Version 3.5.3</div>
        <p>Sign in or create an account to brawl or chill accross schools, for everyone!</p>
        <div class="login-container">
            <input id="username" type="text" placeholder="Username">
            <input id="password" type="password" placeholder="Password">
            <button onclick="login()">Login</button>
            <button onclick="signup()">Sign Up</button>
            <button onclick="toggleControls()">Show Controls</button>
            <button id="resetDataBtn" onclick="resetData()">Reset Data</button>
            <div id="controlsBox">
                <h3>Controls</h3>
                <ul>
                    <li><b>WASD/Arrow Keys</b>: Move (camera-relative)</li>
                    <li><b>Space</b>: Jump</li>
                    <li><b>E</b>: Attack (Fight mode)</li>
                    <li><b>C</b>: Toggle server chat</li>
                    <li><b>UI Buttons</b>: Open Skin Shop, Weapon Shop, Player List, Toggle POV, Report Player</li>
                </ul>
            </div>
        </div>
    </div>
    <div id="homePage" style="display: none;">
        <div id="coneconDisplay">Conecons: 0</div>
        <h1>ConeWorks</h1>
        <div id="versionDisplay">Version 3.5.3</div>
        <p>Create or join epic servers to brawl or chill.</p>
        <div class="game-buttons">
            <button onclick="loadServerPage()">Join Server</button>
            <button onclick="loadCreateServerPage()">Create Server</button>
            <button onclick="toggleChatBox()">Chat & Friends</button>
            <button onclick="toggleFriendBox()">Search Players</button>
            <button onclick="togglePlayerList()">Player List</button>
            <button onclick="testMultiplayer()">Test Multiplayer</button>
            <button onclick="loadSettingsPage()">Settings</button>
            <button onclick="testUI()">Test UI</button>
            <button onclick="testUI2()">Test UI 2</button>
            <button id="reviewReportsBtn" style="display: none;" onclick="reviewReports()">Review Reports</button>
            <button id="clearCacheBtn" style="display: none;" onclick="clearCache()">Clear Cache</button>
        </div>
        <p>Earn 1 Conecon per minute in-game to buy skins and weapons!</p>
    </div>
    <div id="serverPage" style="display: none;">
        <h1>Join a Server</h1>
        <p>Search for a server or join a random one!</p>
        <input id="serverSearch" type="text" placeholder="Search servers..." oninput="updateServerSuggestions(); updateServerList()">
        <label for="modeFilter">Filter Mode:</label>
        <select id="modeFilter" aria-label="Filter servers by game mode" onchange="updateServerSuggestions(); updateServerList()">
            <option value="all">All Modes</option>
            <option value="fight">Fight</option>
            <option value="chill">Chill</option>
        </select>
        <div id="serverSuggestions"></div>
        <div id="serverList">
            <table>
                <thead>
                    <tr><th>Name</th><th>Mode</th><th>Players</th><th>Action</th></tr>
                </thead>
                <tbody id="serverTableBody"></tbody>
            </table>
        </div>
        <div class="game-buttons">
            <button onclick="joinServer('random')">Join Random</button>
            <button onclick="joinServer(document.getElementById('serverSearch').value)">Join Server</button>
            <button onclick="showHome()">Back</button>
        </div>
    </div>
    <div id="createServerPage" style="display: none;">
        <h1>Create a Server</h1>
        <p>Choose a name and mode for your server!</p>
        <input id="newServerName" type="text" placeholder="Server Name">
        <label for="newServerMode">Server Mode:</label>
        <select id="newServerMode" aria-label="Select server game mode">
            <option value="fight">Fight</option>
            <option value="chill">Chill</option>
        </select>
        <div class="game-buttons">
            <button onclick="createServer()">Create</button>
            <button onclick="showHome()">Back</button>
        </div>
    </div>
    <div id="settingsPage" style="display: none;">
        <h1>Settings</h1>
        <p>Customize your ConeWorks experience.</p>
        <div class="settings-container">
            <label for="defaultPOV">Default POV on Join:</label>
            <select id="defaultPOV" aria-label="Select default camera perspective">
                <option value="third">Third-Person</option>
                <option value="first">First-Person</option>
            </select>
            <label for="mouseSensitivity">Mouse Sensitivity:</label>
            <input type="range" id="mouseSensitivity" min="0.001" max="0.01" step="0.001" value="0.002">
            <label for="currencyDisplay">Currency Display:</label>
            <select id="currencyDisplay" aria-label="Select currency display position">
                <option value="top-left">Top-Left</option>
                <option value="top-right">Top-Right</option>
            </select>
            <button onclick="saveSettings()">Save</button>
            <button onclick="backupData()">Backup Data</button>
            <button onclick="restoreData()">Restore Data</button>
            <button onclick="showDeleteAccount()">Delete Account</button>
            <button onclick="showHome()">Back</button>
        </div>
    </div>
    <div id="deleteAccountBox" style="display: none;">
        <h2>Delete Account</h2>
        <p>Enter your username and password to confirm deletion.</p>
        <input id="deleteUsername" type="text" placeholder="Username">
        <input id="deletePassword" type="password" placeholder="Password">
        <div class="game-buttons">
            <button onclick="deleteAccount()">Confirm Delete</button>
            <button onclick="document.getElementById('deleteAccountBox').style.display='none'">Cancel</button>
        </div>
    </div>
    <div id="playerListBox" style="display: none;">
        <h2>Player Leaderboard</h2>
        <table>
            <thead>
                <tr><th>Username</th><th>Wins</th><th>Conecons</th><th>Action</th></tr>
            </thead>
            <tbody id="playerList"></tbody>
        </table>
        <button onclick="togglePlayerList()">Close</button>
    </div>
    <canvas id="canvas" width="800" height="600" allow="fullscreen"></canvas>
    <button id="backBtn" class="back-btn" onclick="leaveServer()" style="display: none;">Leave Server</button>
    <button id="homeBtn" class="back-btn" onclick="showHome()" style="display: none;">Back to Home</button>
    <div id="ui"></div>
    <div id="publicChat" style="display: none;">
        <div id="publicChatMessages"></div>
        <input id="publicChatInput" type="text" placeholder="Server chat..." onkeydown="if(event.key === 'Enter') sendPublicMessage()">
    </div>
    <div id="chatBox" style="display: none;">
        <div id="chatMessages"></div>
        <input id="chatInput" type="text" placeholder="Message friends..." onkeydown="if(event.key === 'Enter') sendMessage()">
        <button onclick="toggleChatBox()">Close</button>
    </div>
    <div id="friendBox" style="display: none;">
        <div>Friends</div>
        <input id="friendSearch" type="text" placeholder="Search players..." oninput="updateFriendSuggestions()">
        <div id="friendSuggestions"></div>
        <div id="friendList"></div>
        <div id="friendRequests"></div>
        <button onclick="sendFriendRequest()">Send Friend Request</button>
        <button onclick="toggleFriendBox()">Close</button>
    </div>
    <div id="notification"></div>
    <div id="voteBox" style="display: none;">
        <h2>Vote for Next Map</h2>
        <div id="voteOptions"></div>
        <button onclick="closeVote()">Close</button>
    </div>
    <div id="reportBox" style="display: none;">
        <h2>Report Player</h2>
        <label for="reportPlayer">Select Player:</label>
        <select id="reportPlayer" aria-label="Select player to report"></select>
        <button onclick="submitReport()">Report</button>
        <button onclick="document.getElementById('reportBox').style.display='none'">Cancel</button>
    </div>
    <div id="reviewReportsBox" style="display: none;">
        <h2>Review Reports</h2>
        <div id="reportList"></div>
        <button onclick="document.getElementById('reviewReportsBox').style.display='none'">Close</button>
    </div>
    <div id="shopBox" style="display: none;">
        <h2>Weapons Shop</h2>
        <div id="weaponList"></div>
        <button onclick="document.getElementById('shopBox').style.display='none'">Close</button>
    </div>
    <div id="skinBox" style="display: none;">
        <h2>Skins Shop</h2>
        <div id="skinList"></div>
        <button onclick="document.getElementById('skinBox').style.display='none'">Close</button>
    </div>
    <input id="restoreInput" type="file" accept=".json" style="display: none;" onchange="handleRestore(event)" title="Restore backup file">
    <label for="restoreInput" style="display: none;">Restore Backup</label>

    <script>
        try {
            console.log('Script loaded successfully');
            let version = 3.53;
            let username = null;
            let sessionId = Date.now() + '-' + Math.random().toString(36).slice(2, 8);
            let accounts = JSON.parse(localStorage.getItem(`coneWorksAccounts_${sessionId}`)) || {};
            let servers = JSON.parse(localStorage.getItem(`coneWorksServers_${sessionId}`)) || [];
            let reports = JSON.parse(localStorage.getItem(`coneWorksReports_${sessionId}`)) || [];
            let bannedPlayers = JSON.parse(localStorage.getItem(`coneWorksBannedPlayers_${sessionId}`)) || [];
            let currentServer = null;
            let conecon = 0;
            let equippedSkin = 'default-boy';
            let equippedWeapon = 'fist';
            let friends = [];
            let friendRequestsSent = [];
            let friendRequestsReceived = [];
            let messages = JSON.parse(localStorage.getItem(`coneWorksMessages_${sessionId}`)) || [];
            let publicMessages = [];
            let pov = 'third';
            let skins = {
                'default-boy': { cost: 0, color: [1, 0, 0, 1] },
                'default-girl': { cost: 0, color: [1, 0.5, 0.5, 1] },
                'ninja-boy': { cost: 50, color: [0.2, 0.2, 0.2, 1] }
            };
            let weapons = {
                'fist': { cost: 0, damage: 10 },
                'sword': { cost: 20, damage: 20 }
            };
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            let ui = document.getElementById('ui');
            const coneconDisplay = document.getElementById('coneconDisplay');
            let players = JSON.parse(localStorage.getItem(`coneWorksPlayers_${sessionId}`)) || {};

            // Custom encoding for save ID
            function customEncode(str) {
                const b64 = btoa(unescape(encodeURIComponent(str)));
                const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
                let result = 'cw_';
                for (let i = 0; i < Math.min(b64.length, 6); i++) {
                    result += chars[(b64.charCodeAt(i) % chars.length)];
                }
                return result;
            }

            function saveCredentials() {
                try {
                    const user = document.getElementById('username').value.trim();
                    const pass = document.getElementById('password').value;
                    if (user && pass) {
                        const state = { username: user, password: pass };
                        const stateJson = JSON.stringify(state);
                        const saveId = customEncode(stateJson);
                        navigator.clipboard.writeText(saveId).then(() => {
                            alert(`Save this ID to recover your account on a new device: ${saveId}`);
                            console.log('Credentials saved:', saveId, 'Session:', sessionId);
                        }).catch(e => {
                            alert(`Failed to copy Save ID: ${saveId}. Copy it manually!`);
                            console.error('Clipboard error:', e);
                        });
                    }
                } catch (e) {
                    console.error('Save credentials error:', e);
                    alert('Error saving credentials. Check console.');
                }
            }

            function clearCache() {
                try {
                    if (username.toLowerCase() !== 'conehead8654') {
                        alert('Only conehead8654 can clear cache!');
                        return;
                    }
                    localStorage.removeItem(`coneWorksServers_${sessionId}`);
                    localStorage.removeItem(`coneWorksReports_${sessionId}`);
                    localStorage.removeItem(`coneWorksMessages_${sessionId}`);
                    localStorage.removeItem(`coneWorksBannedPlayers_${sessionId}`);
                    localStorage.removeItem(`coneWorksPlayers_${sessionId}`);
                    servers = [];
                    reports = [];
                    publicMessages = [];
                    bannedPlayers = [];
                    players = {};
                    alert('Multiplayer cache cleared!');
                    console.log('Cache cleared for session:', sessionId);
                    updateServerList();
                    updatePublicChat();
                } catch (e) {
                    console.error('Clear cache error:', e);
                    alert('Error clearing cache. Check console.');
                }
            }

            function resetData() {
                try {
                    localStorage.removeItem(`coneWorksAccounts_${sessionId}`);
                    localStorage.removeItem(`coneWorksServers_${sessionId}`);
                    localStorage.removeItem(`coneWorksReports_${sessionId}`);
                    localStorage.removeItem(`coneWorksBannedPlayers_${sessionId}`);
                    localStorage.removeItem(`coneWorksPlayers_${sessionId}`);
                    accounts = {};
                    accounts['conehead8654'] = { password: 'Di@d09202015', friends: [], requestsSent: [], wins: 0, conecon: 100, equippedSkin: 'default-boy', equippedWeapon: 'fist' };
                    servers = [];
                    reports = [];
                    bannedPlayers = [];
                    players = {};
                    localStorage.setItem(`coneWorksAccounts_${sessionId}`, JSON.stringify(accounts));
                    localStorage.setItem(`coneWorksServers_${sessionId}`, JSON.stringify(servers));
                    localStorage.setItem(`coneWorksReports_${sessionId}`, JSON.stringify(reports));
                    localStorage.setItem(`coneWorksBannedPlayers_${sessionId}`, JSON.stringify(bannedPlayers));
                    localStorage.setItem(`coneWorksPlayers_${sessionId}`, JSON.stringify(players));
                    alert('Data reset! Try logging in with conehead8654.');
                    console.log('Data reset for session:', sessionId);
                } catch (e) {
                    console.error('Reset data error:', e);
                    alert('Error resetting data. Check console.');
                }
            }

            function login() {
                try {
                    const user = document.getElementById('username').value.trim();
                    const pass = document.getElementById('password').value;
                    const userLower = user.toLowerCase();
                    let matchedUser = Object.keys(accounts).find(u => u.toLowerCase() === userLower);
                    if (matchedUser && accounts[matchedUser].password === pass) {
                        username = matchedUser;
                        conecon = accounts[matchedUser].conecon || 0;
                        equippedSkin = accounts[matchedUser].equippedSkin || 'default-boy';
                        equippedWeapon = accounts[matchedUser].equippedWeapon || 'fist';
                        friends = accounts[matchedUser].friends || [];
                        friendRequestsSent = accounts[matchedUser].requestsSent || [];
                        friendRequestsReceived = JSON.parse(localStorage.getItem(`coneWorksRequestsReceived_${sessionId}`))?.[matchedUser] || [];
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('homePage').style.display = 'block';
                        document.getElementById('fullscreenBtn').style.display = 'block';
                        document.getElementById('reviewReportsBtn').style.display = username.toLowerCase() === 'conehead8654' ? 'block' : 'none';
                        document.getElementById('clearCacheBtn').style.display = username.toLowerCase() === 'conehead8654' ? 'block' : 'none';
                        updateConeconDisplay();
                        updateFriendList();
                        saveCredentials();
                        console.log('Login successful:', matchedUser, 'Session:', sessionId);
                    } else {
                        alert('Invalid username or password!');
                    }
                } catch (e) {
                    console.error('Login error:', e);
                    alert('Error logging in. Check console.');
                }
            }

            function signup() {
                try {
                    const user = document.getElementById('username').value.trim();
                    const pass = document.getElementById('password').value;
                    const userLower = user.toLowerCase();
                    if (user && pass && !Object.keys(accounts).some(u => u.toLowerCase() === userLower) && userLower !== 'conehead8654') {
                        accounts[user] = { password: pass, friends: [], requestsSent: [], wins: 0, conecon: 0, equippedSkin: 'default-boy', equippedWeapon: 'fist' };
                        localStorage.setItem(`coneWorksAccounts_${sessionId}`, JSON.stringify(accounts));
                        username = user;
                        conecon = 0;
                        equippedSkin = 'default-boy';
                        equippedWeapon = 'fist';
                        friends = [];
                        friendRequestsSent = [];
                        friendRequestsReceived = [];
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('homePage').style.display = 'block';
                        document.getElementById('fullscreenBtn').style.display = 'block';
                        document.getElementById('reviewReportsBtn').style.display = 'none';
                        document.getElementById('clearCacheBtn').style.display = 'none';
                        updateConeconDisplay();
                        saveCredentials();
                        console.log('Signup successful:', user, 'Session:', sessionId);
                    } else {
                        alert(Object.keys(accounts).some(u => u.toLowerCase() === userLower) ? 'Username taken!' : 'Invalid username/password or reserved name!');
                    }
                } catch (e) {
                    console.error('Signup error:', e);
                    alert('Error signing up. Check console.');
                }
            }

            function toggleControls() {
                try {
                    const controlsBox = document.getElementById('controlsBox');
                    controlsBox.style.display = controlsBox.style.display === 'none' ? 'block' : 'none';
                    console.log('Toggled controls:', controlsBox.style.display);
                } catch (e) {
                    console.error('Toggle controls error:', e);
                    alert('Error showing controls. Check console.');
                }
            }

            function updateConeconDisplay() {
                coneconDisplay.textContent = `Conecons: ${conecon}`;
            }

            function showHome() {
                document.getElementById('homePage').style.display = 'block';
                document.getElementById('serverPage').style.display = 'none';
                document.getElementById('createServerPage').style.display = 'none';
                document.getElementById('settingsPage').style.display = 'none';
                document.getElementById('fullscreenBtn').style.display = 'block';
                document.getElementById('backBtn').style.display = 'none';
                document.getElementById('homeBtn').style.display = 'none';
                document.getElementById('publicChat').style.display = 'none';
                canvas.style.display = 'none';
                ui.style.display = 'none';
                document.getElementById('reviewReportsBtn').style.display = username && username.toLowerCase() === 'conehead8654' ? 'block' : 'none';
                document.getElementById('clearCacheBtn').style.display = username && username.toLowerCase() === 'conehead8654' ? 'block' : 'none';
                updateFriendList();
                console.log('Returned to home page');
            }

            function loadServerPage() {
                document.getElementById('homePage').style.display = 'none';
                document.getElementById('serverPage').style.display = 'block';
                document.getElementById('fullscreenBtn').style.display = 'block';
                updateServerList();
                console.log('Loaded server page');
            }

            function loadCreateServerPage() {
                document.getElementById('homePage').style.display = 'none';
                document.getElementById('createServerPage').style.display = 'block';
                document.getElementById('fullscreenBtn').style.display = 'block';
                console.log('Loaded create server page');
            }

            function loadSettingsPage() {
                document.getElementById('homePage').style.display = 'none';
                document.getElementById('settingsPage').style.display = 'block';
                document.getElementById('fullscreenBtn').style.display = 'block';
                console.log('Loaded settings page');
            }

            function createServer() {
                try {
                    const name = document.getElementById('newServerName').value.trim();
                    const mode = document.getElementById('newServerMode').value;
                    if (name && !servers.find(s => s.name === name)) {
                        servers.push({ name, mode, players: [username], owner: username });
                        localStorage.setItem(`coneWorksServers_${sessionId}`, JSON.stringify(servers));
                        joinServer(name);
                        console.log('Server created:', name, mode, 'Session:', sessionId);
                    } else {
                        alert('Server name taken or invalid!');
                        console.log('Failed to create server:', name);
                    }
                } catch (e) {
                    console.error('Create server error:', e);
                    alert('Error creating server. Check console.');
                }
            }

            function updateServerList() {
                try {
                    const tbody = document.getElementById('serverTableBody');
                    tbody.innerHTML = '';
                    servers.forEach(s => {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${s.name}</td><td>${s.mode}</td><td>${s.players ? s.players.length : 0}</td><td><button onclick="joinServer('${s.name}')">Join</button></td>`;
                        tbody.appendChild(row);
                    });
                    console.log('Updated server list:', servers.length, 'servers', 'Session:', sessionId);
                } catch (e) {
                    console.error('Update server list error:', e);
                    alert('Error updating server list. Check console.');
                }
            }

            function updateServerSuggestions() {
                try {
                    const search = document.getElementById('serverSearch').value.toLowerCase();
                    const mode = document.getElementById('modeFilter').value;
                    const suggestions = document.getElementById('serverSuggestions');
                    suggestions.innerHTML = '';
                    servers.filter(s => (mode === 'all' || s.mode === mode) && s.name.toLowerCase().includes(search)).slice(0, 5).forEach(s => {
                        const div = document.createElement('div');
                        div.className = 'suggestion';
                        div.textContent = s.name;
                        div.onclick = () => joinServer(s.name);
                        suggestions.appendChild(div);
                    });
                    console.log('Updated server suggestions');
                } catch (e) {
                    console.error('Update server suggestions error:', e);
                    alert('Error updating suggestions. Check console.');
                }
            }

            function joinServer(name) {
                try {
                    if (bannedPlayers.includes(username)) {
                        alert('You are banned!');
                        console.log('Join attempt blocked: user banned', username);
                        return;
                    }
                    if (name === 'random') {
                        if (servers.length === 0) {
                            alert('No servers available!');
                            console.log('No servers available for random join');
                            return;
                        }
                        currentServer = servers.reduce((max, s) => (s.players?.length || 0) > (max.players?.length || 0) ? s : max, servers[0]);
                    } else {
                        currentServer = servers.find(s => s.name === name);
                    }
                    if (currentServer) {
                        if (!currentServer.players) currentServer.players = [];
                        currentServer.players.push(username);
                        localStorage.setItem(`coneWorksServers_${sessionId}`, JSON.stringify(servers));
                        document.getElementById('serverPage').style.display = 'none';
                        canvas.style.display = 'block';
                        document.getElementById('fullscreenBtn').style.display = 'block';
                        document.getElementById('backBtn').style.display = 'block';
                        document.getElementById('homeBtn').style.display = 'none';
                        document.getElementById('publicChat').style.display = 'block';
                        startGame();
                        console.log('Joined server:', currentServer.name, 'Players:', currentServer.players.length, 'Session:', sessionId);
                    } else {
                        alert('Server not found!');
                        console.log('Server not found:', name);
                    }
                } catch (e) {
                    console.error('Join server error:', e);
                    alert('Error joining server. Check console.');
                }
            }

            function leaveServer() {
                try {
                    if (currentServer) {
                        currentServer.players = currentServer.players.filter(p => p !== username);
                        if (currentServer.players.length === 0) {
                            servers = servers.filter(s => s.name !== currentServer.name);
                        }
                        localStorage.setItem(`coneWorksServers_${sessionId}`, JSON.stringify(servers));
                        localStorage.setItem(`coneWorksPlayers_${sessionId}`, JSON.stringify(players));
                    }
                    currentServer = null;
                    canvas.style.display = 'none';
                    document.getElementById('fullscreenBtn').style.display = 'block';
                    document.getElementById('backBtn').style.display = 'none';
                    document.getElementById('publicChat').style.display = 'none';
                    ui.style.display = 'none';
                    showHome();
                    console.log('Left server');
                } catch (e) {
                    console.error('Leave server error:', e);
                    alert('Error leaving server. Check console.');
                }
            }

            function startGame() {
                try {
                    console.log('Starting game');
                    let player = {
                        x: 400,
                        y: 300,
                        z: 0,
                        speed: 5,
                        jumping: false,
                        jumpHeight: 50,
                        jumpProgress: 0,
                        walkProgress: 0,
                        direction: 0
                    };
                    players[username] = player;
                    localStorage.setItem(`coneWorksPlayers_${sessionId}`, JSON.stringify(players));
                    canvas.style.display = 'block';
                    ui.style.display = 'block';
                    let keys = {};

                    document.addEventListener('keydown', (e) => {
                        keys[e.key] = true;
                        if (e.key === ' ' && !player.jumping) {
                            player.jumping = true;
                            player.jumpProgress = 0;
                            console.log('Jump started:', username);
                        }
                        if (e.key === 'c') {
                            togglePublicChat();
                        }
                    });

                    document.addEventListener('keyup', (e) => {
                        keys[e.key] = false;
                    });

                    function updateGame() {
                        try {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            let moving = false;

                            if (keys['ArrowLeft'] || keys['a']) {
                                player.x = Math.max(0, player.x - player.speed);
                                player.direction = -1;
                                moving = true;
                            }
                            if (keys['ArrowRight'] || keys['d']) {
                                player.x = Math.min(800, player.x + player.speed);
                                player.direction = 1;
                                moving = true;
                            }
                            if (keys['ArrowUp'] || keys['w']) {
                                player.y = Math.max(285, player.y - player.speed);
                                moving = true;
                            }
                            if (keys['ArrowDown'] || keys['s']) {
                                player.y = Math.min(450, player.y + player.speed);
                                moving = true;
                            }

                            if (player.jumping) {
                                player.jumpProgress += 0.05;
                                if (player.jumpProgress < 0.5) {
                                    player.z = player.jumpHeight * Math.sin(player.jumpProgress * Math.PI);
                                } else if (player.jumpProgress >= 1) {
                                    player.jumping = false;
                                    player.z = 0;
                                    player.jumpProgress = 0;
                                }
                                console.log('Jump progress:', player.jumpProgress, 'Z:', player.z);
                            }

                            if (moving) {
                                player.walkProgress += 0.1;
                            } else {
                                player.walkProgress = 0;
                            }

                            players[username] = player;
                            localStorage.setItem(`coneWorksPlayers_${sessionId}`, JSON.stringify(players));

                            Object.values(players).forEach(p => drawPlayer(p));
                            requestAnimationFrame(updateGame);
                        } catch (e) {
                            console.error('Update game error:', e);
                            alert('Error updating game. Check console.');
                        }
                    }

                    function drawPlayer(p) {
                        try {
                            ctx.save();
                            ctx.translate(p.x, p.y - p.z);

                            // Jump animation: scale vertically
                            let scaleY = 1;
                            if (p.jumping) {
                                scaleY = p.jumpProgress < 0.5 ? 1 + p.jumpProgress * 0.3 : 1.3 - (p.jumpProgress - 0.5) * 0.3;
                            }
                            ctx.scale(1, scaleY);

                            // Walk animation: leg rotation
                            let legAngle = p.walkProgress ? Math.sin(p.walkProgress * Math.PI) * 0.5 : 0;

                            // Draw stick figure
                            ctx.fillStyle = skins[p.equippedSkin || 'default-boy'].color.map(c => c * 255).join(',');
                            ctx.beginPath();
                            ctx.arc(0, -20, 10, 0, Math.PI * 2); // Head
                            ctx.fill();

                            ctx.beginPath();
                            ctx.moveTo(0, -10);
                            ctx.lineTo(0, 10); // Body
                            ctx.strokeStyle = ctx.fillStyle;
                            ctx.lineWidth = 5;
                            ctx.stroke();

                            // Arms
                            ctx.beginPath();
                            ctx.moveTo(0, -5);
                            ctx.lineTo(p.direction === 1 ? -15 : 15, 5);
                            ctx.moveTo(0, -5);
                            ctx.lineTo(p.direction === 1 ? 15 : -15, 5);
                            ctx.stroke();

                            // Legs with walk animation
                            ctx.save();
                            ctx.translate(0, 10);
                            ctx.rotate(legAngle);
                            ctx.beginPath();
                            ctx.moveTo(0, 0);
                            ctx.lineTo(-10, 20);
                            ctx.stroke();
                            ctx.restore();

                            ctx.save();
                            ctx.translate(0, 10);
                            ctx.rotate(-legAngle);
                            ctx.beginPath();
                            ctx.moveTo(0, 0);
                            ctx.lineTo(10, 20);
                            ctx.stroke();
                            ctx.restore();

                            // Nametag
                            ctx.fillStyle = 'white';
                            ctx.font = '12px Arial';
                            ctx.textAlign = 'center';
                            ctx.fillText(p.username || 'Player', 0, -30);

                            ctx.restore();
                        } catch (e) {
                            console.error('Draw player error:', e);
                            alert('Error drawing player. Check console.');
                        }
                    }

                    updateGame();
                    console.log('Game started');
                } catch (e) {
                    console.error('Start game error:', e);
                    alert('Error starting game. Check console.');
                }
            }

            function togglePublicChat() {
                const chat = document.getElementById('publicChat');
                chat.style.display = chat.style.display === 'none' ? 'block' : 'none';
                console.log('Toggled public chat:', chat.style.display);
            }

            function sendPublicMessage() {
                try {
                    const input = document.getElementById('publicChatInput');
                    const message = input.value.trim();
                    if (message && currentServer) {
                        publicMessages.push({ sender: username, message, timestamp: Date.now() });
                        localStorage.setItem(`coneWorksMessages_${sessionId}`, JSON.stringify(publicMessages));
                        input.value = '';
                        updatePublicChat();
                        console.log('Sent public message:', message);
                    }
                } catch (e) {
                    console.error('Send public message error:', e);
                    alert('Error sending message. Check console.');
                }
            }

            function updatePublicChat() {
                try {
                    const messagesDiv = document.getElementById('publicChatMessages');
                    messagesDiv.innerHTML = publicMessages.map(m => `<div>${m.sender}: ${m.message}</div>`).join('');
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    console.log('Updated public chat');
                } catch (e) {
                    console.error('Update public chat error:', e);
                    alert('Error updating chat. Check console.');
                }
            }

            function toggleChatBox() {
                const chatBox = document.getElementById('chatBox');
                chatBox.style.display = chatBox.style.display === 'none' ? 'block' : 'none';
                if (chatBox.style.display === 'block') updateChat();
                console.log('Toggled chat box:', chatBox.style.display);
            }

            function sendMessage() {
                try {
                    const input = document.getElementById('chatInput');
                    const message = input.value.trim();
                    if (message) {
                        messages.push({ sender: username, message, timestamp: Date.now() });
                        localStorage.setItem(`coneWorksMessages_${sessionId}`, JSON.stringify(messages));
                        input.value = '';
                        updateChat();
                        console.log('Sent friend message:', message);
                    }
                } catch (e) {
                    console.error('Send message error:', e);
                    alert('Error sending message. Check console.');
                }
            }

            function updateChat() {
                try {
                    const messagesDiv = document.getElementById('chatMessages');
                    messagesDiv.innerHTML = messages.map(m => `<div>${m.sender}: ${m.message}</div>`).join('');
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    console.log('Updated chat');
                } catch (e) {
                    console.error('Update chat error:', e);
                    alert('Error updating chat. Check console.');
                }
            }

            function toggleFriendBox() {
                const friendBox = document.getElementById('friendBox');
                friendBox.style.display = friendBox.style.display === 'none' ? 'block' : 'none';
                if (friendBox.style.display === 'block') updateFriendList();
                console.log('Toggled friend box:', friendBox.style.display);
            }

            function updateFriendList() {
                try {
                    const friendList = document.getElementById('friendList');
                    friendList.innerHTML = friends.length ? friends.map(f => `<div>${f}</div>`).join('') : '<div>No friends yet!</div>';
                    const requests = document.getElementById('friendRequests');
                    requests.innerHTML = friendRequestsReceived.length ? friendRequestsReceived.map(r => `<div>${r} <button onclick="acceptFriendRequest('${r}')">Accept</button></div>`).join('') : '<div>No friend requests!</div>';
                    console.log('Updated friend list');
                } catch (e) {
                    console.error('Update friend list error:', e);
                    alert('Error updating friend list. Check console.');
                }
            }

            function updateFriendSuggestions() {
                try {
                    const search = document.getElementById('friendSearch').value.toLowerCase();
                    const suggestions = document.getElementById('friendSuggestions');
                    suggestions.innerHTML = '';
                    Object.keys(accounts).filter(u => u.toLowerCase().includes(search) && u !== username && !friends.includes(u)).slice(0, 5).forEach(u => {
                        const div = document.createElement('div');
                        div.className = 'suggestion';
                        div.textContent = u;
                        div.onclick = () => document.getElementById('friendSearch').value = u;
                        suggestions.appendChild(div);
                    });
                    console.log('Updated friend suggestions');
                } catch (e) {
                    console.error('Update friend suggestions error:', e);
                    alert('Error updating suggestions. Check console.');
                }
            }

            function sendFriendRequest() {
                try {
                    const target = document.getElementById('friendSearch').value.trim();
                    const targetLower = target.toLowerCase();
                    if (target && Object.keys(accounts).some(u => u.toLowerCase() === targetLower) && !friends.includes(target) && !friendRequestsSent.includes(target)) {
                        let targetUser = Object.keys(accounts).find(u => u.toLowerCase() === targetLower);
                        let requests = JSON.parse(localStorage.getItem(`coneWorksRequestsReceived_${sessionId}`)) || {};
                        requests[targetUser] = requests[targetUser] || [];
                        requests[targetUser].push(username);
                        localStorage.setItem(`coneWorksRequestsReceived_${sessionId}`, JSON.stringify(requests));
                        friendRequestsSent.push(targetUser);
                        accounts[username].requestsSent = friendRequestsSent;
                        localStorage.setItem(`coneWorksAccounts_${sessionId}`, JSON.stringify(accounts));
                        alert(`Friend request sent to ${targetUser}!`);
                        console.log('Friend request sent:', username, 'to', targetUser);
                    } else {
                        alert('Invalid user or request already sent!');
                        console.log('Failed to send friend request:', target);
                    }
                } catch (e) {
                    console.error('Send friend request error:', e);
                    alert('Error sending friend request. Check console.');
                }
            }

            function acceptFriendRequest(sender) {
                try {
                    friendRequestsReceived = friendRequestsReceived.filter(r => r !== sender);
                    friends.push(sender);
                    accounts[username].friends = friends;
                    let senderData = JSON.parse(localStorage.getItem(`coneWorksAccounts_${sessionId}`)) || {};
                    senderData[sender] = senderData[sender] || {};
                    senderData[sender].friends = senderData[sender].friends || [];
                    senderData[sender].friends.push(username);
                    senderData[sender].requestsSent = senderData[sender].requestsSent.filter(r => r !== username);
                    let requests = JSON.parse(localStorage.getItem(`coneWorksRequestsReceived_${sessionId}`)) || {};
                    requests[username] = friendRequestsReceived;
                    localStorage.setItem(`coneWorksAccounts_${sessionId}`, JSON.stringify(senderData));
                    localStorage.setItem(`coneWorksRequestsReceived_${sessionId}`, JSON.stringify(requests));
                    updateFriendList();
                    console.log('Friend request accepted:', sender);
                } catch (e) {
                    console.error('Accept friend request error:', e);
                    alert('Error accepting friend request. Check console.');
                }
            }

            function togglePlayerList() {
                const playerListBox = document.getElementById('playerListBox');
                playerListBox.style.display = playerListBox.style.display === 'none' ? 'block' : 'none';
                if (playerListBox.style.display === 'block') updatePlayerList();
                console.log('Toggled player list:', playerListBox.style.display);
            }

            function updatePlayerList() {
                try {
                    const playerList = document.getElementById('playerList');
                    playerList.innerHTML = '';
                    Object.keys(accounts).forEach(u => {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${u}</td><td>${accounts[u].wins || 0}</td><td>${accounts[u].conecon || 0}</td><td><button onclick="reportPlayer('${u}')">Report</button></td>`;
                        playerList.appendChild(row);
                    });
                    console.log('Updated player list');
                } catch (e) {
                    console.error('Update player list error:', e);
                    alert('Error updating player list. Check console.');
                }
            }

            function reportPlayer(player) {
                document.getElementById('reportPlayer').innerHTML = `<option value="${player}">${player}</option>`;
                document.getElementById('reportBox').style.display = 'block';
                console.log('Reporting player:', player);
            }

            function submitReport() {
                try {
                    const reported = document.getElementById('reportPlayer').value;
                    if (reported && reported !== username) {
                        reports.push({ reporter: username, reported, timestamp: Date.now() });
                        localStorage.setItem(`coneWorksReports_${sessionId}`, JSON.stringify(reports));
                        document.getElementById('reportBox').style.display = 'none';
                        alert('Report submitted!');
                        console.log('Report submitted:', username, 'reported', reported);
                    } else {
                        alert('Cannot report yourself or invalid player!');
                    }
                } catch (e) {
                    console.error('Submit report error:', e);
                    alert('Error submitting report. Check console.');
                }
            }

            function reviewReports() {
                try {
                    if (username.toLowerCase() !== 'conehead8654') {
                        alert('Only conehead8654 can review reports!');
                        return;
                    }
                    const reportList = document.getElementById('reportList');
                    reportList.innerHTML = reports.map(r => `<div>${r.reporter} reported ${r.reported} at ${new Date(r.timestamp).toLocaleString()} <button onclick="banPlayer('${r.reported}')">Ban</button></div>`).join('');
                    document.getElementById('reviewReportsBox').style.display = 'block';
                    console.log('Reviewing reports');
                } catch (e) {
                    console.error('Review reports error:', e);
                    alert('Error reviewing reports. Check console.');
                }
            }

            function banPlayer(player) {
                try {
                    if (username.toLowerCase() !== 'conehead8654') {
                        alert('Only conehead8654 can ban players!');
                        return;
                    }
                    if (!bannedPlayers.includes(player)) {
                        bannedPlayers.push(player);
                        localStorage.setItem(`coneWorksBannedPlayers_${sessionId}`, JSON.stringify(bannedPlayers));
                        servers.forEach(s => s.players = s.players.filter(p => p !== player));
                        localStorage.setItem(`coneWorksServers_${sessionId}`, JSON.stringify(servers));
                        document.getElementById('reviewReportsBox').style.display = 'none';
                        alert(`${player} banned!`);
                        console.log('Player banned:', player);
                    }
                } catch (e) {
                    console.error('Ban player error:', e);
                    alert('Error banning player. Check console.');
                }
            }

            function saveSettings() {
                try {
                    accounts[username].pov = document.getElementById('defaultPOV').value;
                    accounts[username].mouseSensitivity = document.getElementById('mouseSensitivity').value;
                    accounts[username].currencyDisplay = document.getElementById('currencyDisplay').value;
                    localStorage.setItem(`coneWorksAccounts_${sessionId}`, JSON.stringify(accounts));
                    updateConeconDisplay();
                    alert('Settings saved!');
                    console.log('Settings saved for:', username);
                } catch (e) {
                    console.error('Save settings error:', e);
                    alert('Error saving settings. Check console.');
                }
            }

            function backupData() {
                try {
                    const data = {
                        accounts,
                        servers,
                        reports,
                        bannedPlayers,
                        messages,
                        players
                    };
                    const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'coneWorks_backup.json';
                    a.click();
                    URL.revokeObjectURL(url);
                    console.log('Data backed up');
                } catch (e) {
                    console.error('Backup data error:', e);
                    alert('Error backing up data. Check console.');
                }
            }

            function restoreData() {
                document.getElementById('restoreInput').click();
                console.log('Initiated data restore');
            }

            function handleRestore(event) {
                try {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const data = JSON.parse(e.target.result);
                            localStorage.setItem(`coneWorksAccounts_${sessionId}`, JSON.stringify(data.accounts));
                            localStorage.setItem(`coneWorksServers_${sessionId}`, JSON.stringify(data.servers));
                            localStorage.setItem(`coneWorksReports_${sessionId}`, JSON.stringify(data.reports));
                            localStorage.setItem(`coneWorksBannedPlayers_${sessionId}`, JSON.stringify(data.bannedPlayers));
                            localStorage.setItem(`coneWorksMessages_${sessionId}`, JSON.stringify(data.messages));
                            localStorage.setItem(`coneWorksPlayers_${sessionId}`, JSON.stringify(data.players));
                            accounts = data.accounts;
                            servers = data.servers;
                            reports = data.reports;
                            bannedPlayers = data.bannedPlayers;
                            messages = data.messages;
                            players = data.players;
                            alert('Data restored!');
                            console.log('Data restored');
                            showHome();
                        };
                        reader.readAsText(file);
                    }
                } catch (e) {
                    console.error('Restore data error:', e);
                    alert('Error restoring data. Check console.');
                }
            }

            function showDeleteAccount() {
                document.getElementById('deleteAccountBox').style.display = 'block';
                console.log('Showing delete account box');
            }

            function deleteAccount() {
                try {
                    const user = document.getElementById('deleteUsername').value.trim();
                    const pass = document.getElementById('deletePassword').value;
                    const userLower = user.toLowerCase();
                    let matchedUser = Object.keys(accounts).find(u => u.toLowerCase() === userLower);
                    if (matchedUser && accounts[matchedUser].password === pass && matchedUser === username) {
                        delete accounts[matchedUser];
                        localStorage.setItem(`coneWorksAccounts_${sessionId}`, JSON.stringify(accounts));
                        servers.forEach(s => s.players = s.players.filter(p => p !== matchedUser));
                        localStorage.setItem(`coneWorksServers_${sessionId}`, JSON.stringify(servers));
                        document.getElementById('deleteAccountBox').style.display = 'none';
                        showHome();
                        username = null;
                        alert('Account deleted!');
                        console.log('Account deleted:', matchedUser);
                    } else {
                        alert('Invalid username or password!');
                    }
                } catch (e) {
                    console.error('Delete account error:', e);
                    alert('Error deleting account. Check console.');
                }
            }

            function testMultiplayer() {
                try {
                    alert('Testing multiplayer: Check console for player data.');
                    console.log('Multiplayer test - Players:', players, 'Session:', sessionId);
                } catch (e) {
                    console.error('Test multiplayer error:', e);
                    alert('Error testing multiplayer. Check console.');
                }
            }

            function testUI() {
                try {
                    console.log('Testing UI rendering on home page');
                    if (!ui || !document.body.contains(ui)) {
                        console.log('#ui not found or detached, creating and appending new #ui div');
                        ui = document.createElement('div');
                        ui.id = 'ui';
                        document.body.appendChild(ui);
                    }
                    ui.style.cssText = `
                        display: block !important;
                        position: fixed !important;
                        top: 10px !important;
                        left: 10px !important;
                        z-index: 10000 !important;
                        background: rgba(0, 0, 0, 0.9) !important;
                        padding: 20px !important;
                        border-radius: 5px !important;
                        border: 2px solid #00ffcc !important;
                        opacity: 1 !important;
                        visibility: visible !important;
                        min-width: 200px !important;
                        pointer-events: auto !important;
                    `;
                    ui.innerHTML = '<button id="testButton">Test Button</button>';
                    ui.offsetHeight;
                    console.log('Test UI button rendered');
                    console.log('UI outerHTML:', ui.outerHTML);
                    console.log('UI dimensions:', { width: ui.offsetWidth, height: ui.offsetHeight });
                    console.log('UI computed styles:', window.getComputedStyle(ui));
                    console.log('Parent (body) styles:', window.getComputedStyle(document.body));
                    const elementsAtPoint = document.elementsFromPoint(10, 10);
                    console.log('Elements at (10, 10):', elementsAtPoint.map(el => el.id || el.tagName));
                    const testButton = ui.querySelector('#testButton');
                    if (testButton) {
                        console.log('Test Button computed styles:', window.getComputedStyle(testButton));
                    } else {
                        console.error('Test Button not found in #ui');
                        alert('Test Button failed to render in #ui. Check console.');
                    }
                    setTimeout(() => {
                        ui.style.display = 'none';
                        console.log('Test UI hidden');
                    }, 5000);
                } catch (e) {
                    console.error('Test UI error:', e);
                    alert('Error testing UI. Check console.');
                }
            }

            function testUI2() {
                try {
                    console.log('Testing UI 2 rendering directly on body');
                    const testBtn = document.createElement('button');
                    testBtn.id = 'testButton2';
                    testBtn.textContent = 'Test Button 2';
                    document.body.appendChild(testBtn);
                    testBtn.style.position = 'fixed';
                    testBtn.style.top = '100px';
                    testBtn.style.left = '10px';
                    testBtn.style.zIndex = '10001';
                    testBtn.style.background = '#ff0000';
                    testBtn.style.color = 'white';
                    testBtn.style.border = '2px solid white';
                    testBtn.style.padding = '20px';
                    testBtn.style.fontSize = '24px';
                    console.log('Test UI 2 button rendered');
                    console.log('Test Button 2 dimensions:', { width: testBtn.offsetWidth, height: testBtn.offsetHeight });
                    console.log('Test Button 2 computed styles:', window.getComputedStyle(testBtn));
                    setTimeout(() => {
                        testBtn.remove();
                        console.log('Test UI 2 button removed');
                    }, 5000);
                } catch (e) {
                    console.error('Test UI 2 error:', e);
                    alert('Error testing UI 2. Check console.');
                }
            }

            function toggleFullscreen() {
                try {
                    if (!document.fullscreenElement) {
                        canvas.requestFullscreen().catch(e => console.error('Fullscreen error:', e));
                    } else {
                        document.exitFullscreen();
                    }
                    console.log('Toggled fullscreen');
                } catch (e) {
                    console.error('Fullscreen toggle error:', e);
                    alert('Error toggling fullscreen. Check console.');
                }
            }

            // Initialize default admin account if not exists
            if (!Object.keys(accounts).some(u => u.toLowerCase() === 'conehead8654')) {
                accounts['conehead8654'] = { password: 'Di@d09202015', friends: [], requestsSent: [], wins: 0, conecon: 100, equippedSkin: 'default-boy', equippedWeapon: 'fist' };
                localStorage.setItem(`coneWorksAccounts_${sessionId}`, JSON.stringify(accounts));
                console.log('Initialized default admin account: conehead8654');
            }
        } catch (e) {
            console.error('Script initialization error:', e);
            alert('Error initializing game. Check console.');
        }
    </script>
</body>
</html>
