<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConeWorks</title>
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }
        h1 {
            font-size: 3.5em;
            text-shadow: 0 0 10px #00ffcc;
            margin-bottom: 10px;
        }
        p {
            font-size: 1.2em;
            max-width: 600px;
            text-align: center;
            margin-bottom: 20px;
        }
        #versionDisplay {
            font-size: 1em;
            color: #00ffcc;
            margin-bottom: 20px;
        }
        .login-container, .game-buttons, .settings-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        .game-buttons { flex-direction: row; flex-wrap: wrap; }
        input, button, select {
            padding: 10px;
            font-size: 1.1em;
            border: none;
            border-radius: 5px;
        }
        input, select {
            width: 200px;
            background: #fff;
            color: #333;
        }
        button {
            background: linear-gradient(to right, #ff6b6b, #ff8e53);
            color: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        button#resetDataBtn {
            background: #f44336;
        }
        canvas {
            display: none;
            border: 3px solid #00ffcc;
            border-radius: 10px;
            background: #000;
        }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 5px;
        }
        #publicChat {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 300px;
            height: 150px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            font-size: 14px;
            overflow-y: auto;
            display: none;
        }
        #publicChatInput {
            width: 280px;
            margin-top: 5px;
        }
        #chatBox {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            display: none;
            font-size: 14px;
            overflow-y: auto;
        }
        #chatInput {
            width: 380px;
            margin-top: 5px;
        }
        #friendBox {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 250px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            display: none;
            font-size: 14px;
        }
        #playerListBox {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            display: none;
            font-size: 14px;
            overflow-y: auto;
            max-height: 400px;
        }
        #friendSearch, #serverSearch, #newServerName, #deleteUsername, #deletePassword {
            width: 220px;
            margin-bottom: 5px;
        }
        #friendSuggestions, #serverSuggestions {
            max-height: 100px;
            overflow-y: auto;
            background: #333;
            border-radius: 5px;
        }
        .suggestion {
            padding: 5px;
            cursor: pointer;
        }
        .suggestion:hover {
            background: #555;
        }
        #notification {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: #00ffcc;
            color: #000;
            padding: 10px;
            border-radius: 5px;
            display: none;
            max-width: 300px;
        }
        #voteBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        #reportBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        #shopBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        #skinBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        #deleteAccountBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
            text-align: center;
        }
        .back-btn {
            position: absolute;
            top: 50px;
            right: 10px;
            padding: 10px 20px;
            background: #f44336;
            color: white;
        }
        .back-btn:hover {
            background: #da190b;
        }
        #fullscreenBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10;
        }
        #coneconDisplay {
            position: absolute;
            top: 10px;
            font-size: 20px;
            color: yellow;
        }
        #controlsBox {
            display: none;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            text-align: left;
            max-width: 300px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 5px;
            text-align: left;
            border-bottom: 1px solid #555;
        }
    </style>
</head>
<body>
    <div id="loginPage">
        <h1>ConeWorks</h1>
        <div id="versionDisplay">Version 1.9</div>
        <p>Sign in or create an account to brawl and chill!</p>
        <div class="login-container">
            <input id="username" type="text" placeholder="Username">
            <input id="password" type="password" placeholder="Password">
            <button onclick="login()">Login</button>
            <button onclick="signup()">Sign Up</button>
            <button onclick="toggleControls()">Show Controls</button>
            <button id="resetDataBtn" onclick="resetData()">Reset Data</button>
            <div id="controlsBox">
                <h3>Controls</h3>
                <ul>
                    <li><b>WASD</b>: Move (camera-relative)</li>
                    <li><b>Space</b>: Jump</li>
                    <li><b>E</b>: Attack (Fight mode)</li>
                    <li><b>O</b>: Toggle POV (first/third-person)</li>
                    <li><b>C</b>: Toggle server chat</li>
                    <li><b>R</b>: Report/ban player (Conehead8654 only)</li>
                    <li><b>P</b>: Open weapon shop</li>
                    <li><b>K</b>: Open skin shop</li>
                    <li><b>L</b>: Toggle player list</li>
                </ul>
            </div>
        </div>
    </div>
    <div id="homePage" style="display: none;">
        <div id="coneconDisplay">Conecons: 0</div>
        <h1>ConeWorks</h1>
        <div id="versionDisplay">Version 1.9</div>
        <p>Create or join epic servers to brawl or chill.</p>
        <div class="game-buttons">
            <button onclick="loadServerPage()">Join Server</button>
            <button onclick="loadCreateServerPage()">Create Server</button>
            <button onclick="toggleChatBox()">Chat & Friends</button>
            <button onclick="toggleFriendBox()">Search Players</button>
            <button onclick="togglePlayerList()">Player List</button>
            <button onclick="testMultiplayer()">Test Multiplayer</button>
            <button onclick="loadSettingsPage()">Settings</button>
        </div>
        <p>Earn 1 Conecon per minute in-game to buy skins and weapons!</p>
    </div>
    <div id="serverPage" style="display: none;">
        <h1>Join a Server</h1>
        <p>Search for a server or join a random one!</p>
        <input id="serverSearch" type="text" placeholder="Search servers..." oninput="updateServerSuggestions(); updateServerList()">
        <label for="modeFilter">Filter Mode:</label>
        <select id="modeFilter" aria-label="Filter servers by game mode" onchange="updateServerSuggestions(); updateServerList()">
            <option value="all">All Modes</option>
            <option value="fight">Fight</option>
            <option value="chill">Chill</option>
        </select>
        <div id="serverSuggestions"></div>
        <div id="serverList">
            <table>
                <thead>
                    <tr><th>Name</th><th>Mode</th><th>Players</th><th>Action</th></tr>
                </thead>
                <tbody id="serverTableBody"></tbody>
            </table>
        </div>
        <div class="game-buttons">
            <button onclick="joinServer('random')">Join Random</button>
            <button onclick="joinServer(document.getElementById('serverSearch').value)">Join Server</button>
            <button onclick="showHome()">Back</button>
        </div>
    </div>
    <div id="createServerPage" style="display: none;">
        <h1>Create a Server</h1>
        <p>Choose a name and mode for your server!</p>
        <input id="newServerName" type="text" placeholder="Server Name">
        <label for="newServerMode">Server Mode:</label>
        <select id="newServerMode" aria-label="Select server game mode">
            <option value="fight">Fight</option>
            <option value="chill">Chill</option>
        </select>
        <div class="game-buttons">
            <button onclick="createServer()">Create</button>
            <button onclick="showHome()">Back</button>
        </div>
    </div>
    <div id="settingsPage" style="display: none;">
        <h1>Settings</h1>
        <p>Customize your ConeWorks experience.</p>
        <div class="settings-container">
            <label for="defaultPOV">Default POV on Join:</label>
            <select id="defaultPOV" aria-label="Select default camera perspective">
                <option value="third">Third-Person</option>
                <option value="first">First-Person</option>
            </select>
            <label for="mouseSensitivity">Mouse Sensitivity:</label>
            <input type="range" id="mouseSensitivity" min="0.001" max="0.01" step="0.001" value="0.002">
            <label for="currencyDisplay">Currency Display:</label>
            <select id="currencyDisplay" aria-label="Select currency display position">
                <option value="top-left">Top-Left</option>
                <option value="top-right">Top-Right</option>
            </select>
            <button onclick="saveSettings()">Save</button>
            <button onclick="backupData()">Backup Data</button>
            <button onclick="restoreData()">Restore Data</button>
            <button onclick="showDeleteAccount()">Delete Account</button>
            <button onclick="showHome()">Back</button>
        </div>
    </div>
    <div id="deleteAccountBox" style="display: none;">
        <h2>Delete Account</h2>
        <p>Enter your username and password to confirm deletion.</p>
        <input id="deleteUsername" type="text" placeholder="Username">
        <input id="deletePassword" type="password" placeholder="Password">
        <div class="game-buttons">
            <button onclick="deleteAccount()">Confirm Delete</button>
            <button onclick="document.getElementById('deleteAccountBox').style.display='none'">Cancel</button>
        </div>
    </div>
    <div id="playerListBox" style="display: none;">
        <h2>Player Leaderboard</h2>
        <table>
            <thead>
                <tr><th>Username</th><th>Wins</th><th>Conecons</th><th>Action</th></tr>
            </thead>
            <tbody id="playerList"></tbody>
        </table>
        <button onclick="togglePlayerList()">Close</button>
    </div>
    <canvas id="canvas" width="800" height="600"></canvas>
    <button id="fullscreenBtn" onclick="toggleFullscreen()" style="display: none;">Fullscreen</button>
    <button id="backBtn" class="back-btn" onclick="leaveServer()" style="display: none;">Leave Server</button>
    <div id="ui" style="display: none;"></div>
    <div id="publicChat" style="display: none;">
        <div id="publicChatMessages"></div>
        <input id="publicChatInput" type="text" placeholder="Server chat..." onkeydown="if(event.key === 'Enter') sendPublicMessage()">
    </div>
    <div id="chatBox" style="display: none;">
        <div id="chatMessages"></div>
        <input id="chatInput" type="text" placeholder="Message friends..." onkeydown="if(event.key === 'Enter') sendMessage()">
        <button onclick="toggleChatBox()">Close</button>
    </div>
    <div id="friendBox" style="display: none;">
        <div>Friends</div>
        <input id="friendSearch" type="text" placeholder="Search players..." oninput="updateFriendSuggestions()">
        <div id="friendSuggestions"></div>
        <div id="friendList"></div>
        <div id="friendRequests"></div>
        <button onclick="sendFriendRequest()">Send Friend Request</button>
        <button onclick="toggleFriendBox()">Close</button>
    </div>
    <div id="notification"></div>
    <div id="voteBox" style="display: none;">
        <h2>Vote for Next Map</h2>
        <div id="voteOptions"></div>
        <button onclick="closeVote()">Close</button>
    </div>
    <div id="reportBox" style="display: none;">
        <h2>Report Player</h2>
        <label for="reportPlayer">Select Player:</label>
        <select id="reportPlayer" aria-label="Select player to report"></select>
        <button onclick="submitReport()">Report</button>
        <button onclick="document.getElementById('reportBox').style.display='none'">Cancel</button>
    </div>
    <div id="shopBox" style="display: none;">
        <h2>Weapons Shop</h2>
        <div id="weaponList"></div>
        <button onclick="document.getElementById('shopBox').style.display='none'">Close</button>
    </div>
    <div id="skinBox" style="display: none;">
        <h2>Skins Shop</h2>
        <div id="skinList"></div>
        <button onclick="document.getElementById('skinBox').style.display='none'">Close</button>
    </div>
    <input id="restoreInput" type="file" accept=".json" style="display: none;" onchange="handleRestore(event)" title="Restore backup file">
    <label for="restoreInput" style="display: none;">Restore Backup</label>

    <script>
        try {
            console.log('Script loaded successfully');
            let version = 1.9;
            let username = null;
            let accounts = JSON.parse(localStorage.getItem('coneWorksAccounts')) || {};
            let servers = [];
            let currentServer = null;
            let conecon = 0;
            let equippedSkin = 'default-boy';
            let equippedWeapon = 'fist';
            let friends = [];
            let friendRequestsSent = [];
            let friendRequestsReceived = [];
            let messages = JSON.parse(localStorage.getItem('coneWorksMessages')) || [];
            let publicMessages = [];
            let skins = {
                'default-boy': { cost: 0, color: [1, 0, 0, 1] },
                'default-girl': { cost: 0, color: [1, 0.5, 0.5, 1] },
                'ninja-boy': { cost: 50, color: [0.2, 0.2, 0.2, 1] }
            };
            let weapons = {
                'fist': { cost: 0, damage: 10 },
                'sword': { cost: 20, damage: 20 }
            };
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const ui = document.getElementById('ui');
            const coneconDisplay = document.getElementById('coneconDisplay');
            let player = { x: 400, y: 300, z: 0, speed: 5, jumping: false, jumpHeight: 50 };

            function resetData() {
                localStorage.clear();
                accounts = {};
                accounts['Conehead8654'] = { password: 'Di@d09202015', friends: [], requestsSent: [], wins: 0, conecon: 100, equippedSkin: 'default-boy', equippedWeapon: 'fist' };
                localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                alert('Data reset! Try logging in.');
            }

            function login() {
                try {
                    const user = document.getElementById('username').value.trim();
                    const pass = document.getElementById('password').value;
                    if (!accounts['Conehead8654']) {
                        accounts['Conehead8654'] = { password: 'Di@d09202015', friends: [], requestsSent: [], wins: 0, conecon: 100, equippedSkin: 'default-boy', equippedWeapon: 'fist' };
                        localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                    }
                    if (accounts[user] && accounts[user].password === pass) {
                        username = user;
                        conecon = accounts[user].conecon || 0;
                        equippedSkin = accounts[user].equippedSkin || 'default-boy';
                        equippedWeapon = accounts[user].equippedWeapon || 'fist';
                        friends = accounts[user].friends || [];
                        friendRequestsSent = accounts[user].requestsSent || [];
                        friendRequestsReceived = JSON.parse(localStorage.getItem('coneWorksRequestsReceived'))?.[user] || [];
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('homePage').style.display = 'block';
                        updateConeconDisplay();
                        console.log('Login successful:', user);
                    } else {
                        alert('Invalid username or password!');
                    }
                } catch (e) {
                    console.error('Login error:', e);
                    alert('Error logging in. Check console.');
                }
            }

            function signup() {
                try {
                    const user = document.getElementById('username').value.trim();
                    const pass = document.getElementById('password').value;
                    if (user && pass && !accounts[user] && user !== 'Conehead8654') {
                        accounts[user] = { password: pass, friends: [], requestsSent: [], wins: 0, conecon: 0, equippedSkin: 'default-boy', equippedWeapon: 'fist' };
                        localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                        username = user;
                        conecon = 0;
                        equippedSkin = 'default-boy';
                        equippedWeapon = 'fist';
                        friends = [];
                        friendRequestsSent = [];
                        friendRequestsReceived = [];
                        document.getElementById('loginPage').style.display = 'none';
                        document.getElementById('homePage').style.display = 'block';
                        updateConeconDisplay();
                        console.log('Signup successful:', user);
                    } else {
                        alert(accounts[user] ? 'Username taken!' : 'Invalid username/password or reserved name!');
                    }
                } catch (e) {
                    console.error('Signup error:', e);
                    alert('Error signing up. Check console.');
                }
            }

            function toggleControls() {
                try {
                    const controlsBox = document.getElementById('controlsBox');
                    controlsBox.style.display = controlsBox.style.display === 'none' ? 'block' : 'none';
                    console.log('Toggled controls:', controlsBox.style.display);
                } catch (e) {
                    console.error('Toggle controls error:', e);
                    alert('Error showing controls. Check console.');
                }
            }

            function updateConeconDisplay() {
                coneconDisplay.textContent = `Conecons: ${conecon}`;
            }

            function showHome() {
                document.getElementById('homePage').style.display = 'block';
                document.getElementById('serverPage').style.display = 'none';
                document.getElementById('createServerPage').style.display = 'none';
                document.getElementById('settingsPage').style.display = 'none';
                canvas.style.display = 'none';
            }

            function loadServerPage() {
                document.getElementById('homePage').style.display = 'none';
                document.getElementById('serverPage').style.display = 'block';
                updateServerList();
            }

            function loadCreateServerPage() {
                document.getElementById('homePage').style.display = 'none';
                document.getElementById('createServerPage').style.display = 'block';
            }

            function createServer() {
                const name = document.getElementById('newServerName').value.trim();
                const mode = document.getElementById('newServerMode').value;
                if (name && !servers.find(s => s.name === name)) {
                    servers.push({ name, mode, players: [username], owner: username });
                    joinServer(name);
                } else {
                    alert('Server name taken or invalid!');
                }
            }

            function updateServerList() {
                const tbody = document.getElementById('serverTableBody');
                tbody.innerHTML = '';
                servers.forEach(s => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${s.name}</td><td>${s.mode}</td><td>${s.players.length}</td><td><button onclick="joinServer('${s.name}')">Join</button></td>`;
                    tbody.appendChild(row);
                });
            }

            function updateServerSuggestions() {
                const search = document.getElementById('serverSearch').value.toLowerCase();
                const mode = document.getElementById('modeFilter').value;
                const suggestions = document.getElementById('serverSuggestions');
                suggestions.innerHTML = '';
                servers.filter(s => (mode === 'all' || s.mode === mode) && s.name.toLowerCase().includes(search)).slice(0, 5).forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'suggestion';
                    div.textContent = s.name;
                    div.onclick = () => joinServer(s.name);
                    suggestions.appendChild(div);
                });
            }

            function joinServer(name) {
                if (name === 'random') {
                    currentServer = servers[Math.floor(Math.random() * servers.length)];
                } else {
                    currentServer = servers.find(s => s.name === name);
                }
                if (currentServer) {
                    currentServer.players.push(username);
                    document.getElementById('serverPage').style.display = 'none';
                    canvas.style.display = 'block';
                    document.getElementById('fullscreenBtn').style.display = 'block';
                    document.getElementById('backBtn').style.display = 'block';
                    startGame();
                } else {
                    alert('Server not found!');
                }
            }

            function leaveServer() {
                if (currentServer) {
                    currentServer.players = currentServer.players.filter(p => p !== username);
                    if (currentServer.players.length === 0) {
                        servers = servers.filter(s => s.name !== currentServer.name);
                    }
                }
                currentServer = null;
                canvas.style.display = 'none';
                document.getElementById('fullscreenBtn').style.display = 'none';
                document.getElementById('backBtn').style.display = 'none';
                showHome();
            }

            function startGame() {
                canvas.style.display = 'block';
                function gameLoop() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = 'green';
                    ctx.fillRect(0, 300, canvas.width, canvas.height);
                    ctx.fillStyle = `rgb(${skins[equippedSkin].color[0] * 255}, ${skins[equippedSkin].color[1] * 255}, ${skins[equippedSkin].color[2] * 255})`;
                    ctx.fillRect(player.x, player.y - player.z, 20, 20);
                    ctx.fillStyle = 'white';
                    ctx.font = '12px Arial';
                    ctx.fillText(username, player.x, player.y - player.z - 10);
                    requestAnimationFrame(gameLoop);
                }
                document.addEventListener('keydown', e => {
                    if (e.key === 'w') player.y -= player.speed;
                    if (e.key === 's') player.y += player.speed;
                    if (e.key === 'a') player.x -= player.speed;
                    if (e.key === 'd') player.x += player.speed;
                    if (e.key === ' ') {
                        if (!player.jumping) {
                            player.jumping = true;
                            let jump = 0;
                            const jumpInterval = setInterval(() => {
                                jump += 5;
                                player.z = Math.sin(jump / player.jumpHeight * Math.PI) * player.jumpHeight;
                                if (jump >= player.jumpHeight * 2) {
                                    player.z = 0;
                                    player.jumping = false;
                                    clearInterval(jumpInterval);
                                }
                            }, 20);
                        }
                    }
                });
                gameLoop();
            }

            function toggleFullscreen() {
                if (!document.fullscreenElement) {
                    canvas.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            }

            function toggleChatBox() {
                const chatBox = document.getElementById('chatBox');
                chatBox.style.display = chatBox.style.display === 'none' ? 'block' : 'none';
            }

            function toggleFriendBox() {
                const friendBox = document.getElementById('friendBox');
                friendBox.style.display = friendBox.style.display === 'none' ? 'block' : 'none';
                updateFriendSuggestions();
            }

            function togglePlayerList() {
                const playerListBox = document.getElementById('playerListBox');
                playerListBox.style.display = playerListBox.style.display === 'none' ? 'block' : 'none';
                updatePlayerList();
            }

            function updateFriendSuggestions() {
                const search = document.getElementById('friendSearch').value.toLowerCase();
                const suggestions = document.getElementById('friendSuggestions');
                suggestions.innerHTML = '';
                Object.keys(accounts).filter(u => u !== username && u.toLowerCase().includes(search) && !friends.includes(u)).slice(0, 5).forEach(u => {
                    const div = document.createElement('div');
                    div.className = 'suggestion';
                    div.textContent = u;
                    div.onclick = () => document.getElementById('friendSearch').value = u;
                    suggestions.appendChild(div);
                });
            }

            function sendFriendRequest() {
                const target = document.getElementById('friendSearch').value.trim();
                if (target && accounts[target] && target !== username && !friends.includes(target) && !friendRequestsSent.includes(target)) {
                    friendRequestsSent.push(target);
                    accounts[username].requestsSent = friendRequestsSent;
                    let received = JSON.parse(localStorage.getItem('coneWorksRequestsReceived')) || {};
                    received[target] = received[target] || [];
                    received[target].push(username);
                    localStorage.setItem('coneWorksRequestsReceived', JSON.stringify(received));
                    localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                    alert(`Friend request sent to ${target}!`);
                } else {
                    alert('Invalid user or request already sent!');
                }
            }

            function updatePlayerList() {
                const tbody = document.getElementById('playerList');
                tbody.innerHTML = '';
                Object.keys(accounts).forEach(u => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${u}</td><td>${accounts[u].wins || 0}</td><td>${accounts[u].conecon || 0}</td><td><button onclick="sendFriendRequestTo('${u}')">Add Friend</button></td>`;
                    tbody.appendChild(row);
                });
            }

            function sendFriendRequestTo(user) {
                document.getElementById('friendSearch').value = user;
                sendFriendRequest();
            }

            function sendMessage() {
                const msg = document.getElementById('chatInput').value.trim();
                if (msg) {
                    messages.push({ from: username, text: msg, time: new Date().toISOString() });
                    localStorage.setItem('coneWorksMessages', JSON.stringify(messages));
                    document.getElementById('chatInput').value = '';
                    updateChat();
                }
            }

            function sendPublicMessage() {
                const msg = document.getElementById('publicChatInput').value.trim();
                if (msg && currentServer) {
                    publicMessages.push({ from: username, text: msg, time: new Date().toISOString() });
                    document.getElementById('publicChatInput').value = '';
                    updatePublicChat();
                }
            }

            function updateChat() {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = messages.map(m => `<div>${m.from}: ${m.text} (${new Date(m.time).toLocaleTimeString()})</div>`).join('');
            }

            function updatePublicChat() {
                const publicChatMessages = document.getElementById('publicChatMessages');
                publicChatMessages.innerHTML = publicMessages.map(m => `<div>${m.from}: ${m.text} (${new Date(m.time).toLocaleTimeString()})</div>`).join('');
            }

            function saveSettings() {
                const pov = document.getElementById('defaultPOV').value;
                const sensitivity = document.getElementById('mouseSensitivity').value;
                const currency = document.getElementById('currencyDisplay').value;
                localStorage.setItem('coneWorksDefaultPOV', pov);
                localStorage.setItem('coneWorksMouseSensitivity', sensitivity);
                localStorage.setItem('coneWorksCurrencyDisplay', currency);
                alert('Settings saved!');
            }

            function backupData() {
                const data = {
                    accounts: localStorage.getItem('coneWorksAccounts'),
                    messages: localStorage.getItem('coneWorksMessages'),
                    settings: {
                        pov: localStorage.getItem('coneWorksDefaultPOV'),
                        sensitivity: localStorage.getItem('coneWorksMouseSensitivity'),
                        currency: localStorage.getItem('coneWorksCurrencyDisplay')
                    }
                };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'coneWorksBackup.json';
                a.click();
                URL.revokeObjectURL(url);
                alert('Data backed up!');
            }

            function restoreData() {
                document.getElementById('restoreInput').click();
            }

            function handleRestore(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.accounts) localStorage.setItem('coneWorksAccounts', data.accounts);
                            if (data.messages) localStorage.setItem('coneWorksMessages', data.messages);
                            if (data.settings) {
                                if (data.settings.pov) localStorage.setItem('coneWorksDefaultPOV', data.settings.pov);
                                if (data.settings.sensitivity) localStorage.setItem('coneWorksMouseSensitivity', data.settings.sensitivity);
                                if (data.settings.currency) localStorage.setItem('coneWorksCurrencyDisplay', data.settings.currency);
                            }
                            accounts = JSON.parse(localStorage.getItem('coneWorksAccounts')) || {};
                            messages = JSON.parse(localStorage.getItem('coneWorksMessages')) || [];
                            alert('Data restored! Try logging in.');
                        } catch (e) {
                            console.error('Restore error:', e);
                            alert('Error restoring data. Check console.');
                        }
                    };
                    reader.readAsText(file);
                }
            }

            function deleteAccount() {
                const user = document.getElementById('deleteUsername').value.trim();
                const pass = document.getElementById('deletePassword').value;
                if (user === username && accounts[user] && accounts[user].password === pass) {
                    delete accounts[user];
                    localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
                    username = null;
                    document.getElementById('deleteAccountBox').style.display = 'none';
                    document.getElementById('settingsPage').style.display = 'none';
                    document.getElementById('loginPage').style.display = 'block';
                    alert('Account deleted!');
                } else {
                    alert('Invalid username or password!');
                }
            }

            function showDeleteAccount() {
                document.getElementById('deleteAccountBox').style.display = 'block';
            }

            function testMultiplayer() {
                canvas.style.display = 'block';
                document.getElementById('homePage').style.display = 'none';
                startGame();
            }

            // Initialize
            if (!accounts['Conehead8654']) {
                accounts['Conehead8654'] = { password: 'Di@d09202015', friends: [], requestsSent: [], wins: 0, conecon: 100, equippedSkin: 'default-boy', equippedWeapon: 'fist' };
                localStorage.setItem('coneWorksAccounts', JSON.stringify(accounts));
            }
            document.getElementById('versionDisplay').textContent = `Version ${version}`;
            updateConeconDisplay();
        } catch (e) {
            console.error('Script initialization error:', e);
            alert('Error loading game. Check console.');
        }
    </script>
</body>
</html>
